[{"node": {"avatar_large": "https://cdn.v2ex.com/navatar/d6ef/5f7f/1114_large.png?m=1753446338", "name": "solana", "avatar_normal": "https://cdn.v2ex.com/navatar/d6ef/5f7f/1114_normal.png?m=1753446338", "title": "Solana", "url": "https://www.v2ex.com/go/solana", "topics": 639, "footer": "", "header": "Global State Machine", "title_alternative": "Solana", "avatar_mini": "https://cdn.v2ex.com/navatar/d6ef/5f7f/1114_mini.png?m=1753446338", "stars": 571, "aliases": [], "root": false, "id": 1114, "parent_node_name": "crypto"}, "member": {"id": 757359, "username": "PilgrimSun", "url": "https://www.v2ex.com/u/PilgrimSun", "website": "", "twitter": null, "psn": null, "github": null, "btc": null, "location": "", "tagline": "孙行者", "bio": "", "avatar_mini": "https://cdn.v2ex.com/avatar/1ee1/3002/757359_mini.png?m=1755825104", "avatar_normal": "https://cdn.v2ex.com/avatar/1ee1/3002/757359_normal.png?m=1755825104", "avatar_large": "https://cdn.v2ex.com/avatar/1ee1/3002/757359_large.png?m=1755825104", "avatar_xlarge": "https://cdn.v2ex.com/avatar/1ee1/3002/757359_xlarge.png?m=1755825104", "avatar_xxlarge": "https://cdn.v2ex.com/avatar/1ee1/3002/757359_xxlarge.png?m=1755825104", "avatar_xxxlarge": "https://cdn.v2ex.com/avatar/1ee1/3002/757359_xxxlarge.png?m=1755825104", "created": 1752474174, "last_modified": 1755825104, "pro": 0}, "last_reply_by": "ZikL", "last_touched": 1757963407, "title": "关于我买和卖 v 币的说明", "url": "https://www.v2ex.com/t/1160134", "created": 1758164132, "deleted": 0, "content": "昨天，今天，分两次卖出了大约 300 万的 v 币\r\n已经被抓出来要游街了感觉😂\r\n说明一下我买和卖 vb 的过程。\r\n本人是币圈小散。主要玩合约。玩数字货币有 10 年了。\r\n当时我在 x 上看到 v 币毕业的消息，作为一个很少说话，但是很早就注册 V2EX 的水友，看到这个消息非常激动。\r\nMeme 币那么多，终于有老子认识的了！\r\n而且互联网圈，v 站知名度大家应该都是有共识的。\r\n总之，我觉得 v 币有搞头。\r\n我是一个现实主义者，情怀和喜欢 v 站，当然不可否认，但是买 v 币最主要还是觉得可以赚钱。\r\n相信大家应该都一样吧。\r\n最近这段时间，美联储降息，我觉得市场会发生突变，所以在币安开了一点合约。\r\n接下来就是来回被打脸了。\r\n合约仓位岌岌可危，不得已只能卖币补保证金，希望能保住自己的仓位。😂（苟延残喘）\r\n\r\n给大家造成的不愉快表示抱歉，也希望大家理解。我属实也是忍痛割肉，毕竟我还是很看好 v 币的。\r\n\r\n这次卖货不是什么大佬砸盘，只是一个币圈小散断尾求生的挣扎。以后好起来一定还会继续回来。\r\n\r\n话分两头，很多 v 站好友还没买入，我这把割肉也算是帮大家收集廉价筹码了吧啊😂\r\n\r\n大家轻拍吧😂❤️\r\n\r\n今天起三日内所有评论，我打赏 100v 币以表歉意。\r\n\r\n最后，我胡汉三还会回来的！", "content_rendered": "昨天，今天，分两次卖出了大约 300 万的 v 币<br />已经被抓出来要游街了感觉😂<br />说明一下我买和卖 vb 的过程。<br />本人是币圈小散。主要玩合约。玩数字货币有 10 年了。<br />当时我在 x 上看到 v 币毕业的消息，作为一个很少说话，但是很早就注册 V2EX 的水友，看到这个消息非常激动。<br />Meme 币那么多，终于有老子认识的了！<br />而且互联网圈，v 站知名度大家应该都是有共识的。<br />总之，我觉得 v 币有搞头。<br />我是一个现实主义者，情怀和喜欢 v 站，当然不可否认，但是买 v 币最主要还是觉得可以赚钱。<br />相信大家应该都一样吧。<br />最近这段时间，美联储降息，我觉得市场会发生突变，所以在币安开了一点合约。<br />接下来就是来回被打脸了。<br />合约仓位岌岌可危，不得已只能卖币补保证金，希望能保住自己的仓位。😂（苟延残喘）<br /><br />给大家造成的不愉快表示抱歉，也希望大家理解。我属实也是忍痛割肉，毕竟我还是很看好 v 币的。<br /><br />这次卖货不是什么大佬砸盘，只是一个币圈小散断尾求生的挣扎。以后好起来一定还会继续回来。<br /><br />话分两头，很多 v 站好友还没买入，我这把割肉也算是帮大家收集廉价筹码了吧啊😂<br /><br />大家轻拍吧😂❤️<br /><br />今天起三日内所有评论，我打赏 100v 币以表歉意。<br /><br />最后，我胡汉三还会回来的！", "last_modified": 1758164132, "replies": 300, "id": 1160134}, {"node": {"avatar_large": "https://cdn.v2ex.com/navatar/c20a/d4d7/12_large.png?m=1751718333", "name": "qna", "avatar_normal": "https://cdn.v2ex.com/navatar/c20a/d4d7/12_normal.png?m=1751718333", "title": "问与答", "url": "https://www.v2ex.com/go/qna", "topics": 233729, "footer": "", "header": "<!--\r\n一个更好的世界需要你持续地提出好问题。\r\n-->", "title_alternative": "Questions and Answers", "avatar_mini": "https://cdn.v2ex.com/navatar/c20a/d4d7/12_mini.png?m=1751718333", "stars": 4402, "aliases": [], "root": false, "id": 12, "parent_node_name": "v2ex"}, "member": {"id": 719709, "username": "Void000", "url": "https://www.v2ex.com/u/Void000", "website": "", "twitter": null, "psn": null, "github": null, "btc": null, "location": "", "tagline": "", "bio": "", "avatar_mini": "https://cdn.v2ex.com/gravatar/196ddfd2ae2fd3a8bf7cdc534ac6bbdb?s=24&d=retro", "avatar_normal": "https://cdn.v2ex.com/gravatar/196ddfd2ae2fd3a8bf7cdc534ac6bbdb?s=48&d=retro", "avatar_large": "https://cdn.v2ex.com/gravatar/196ddfd2ae2fd3a8bf7cdc534ac6bbdb?s=73&d=retro", "created": 1731392735, "last_modified": 1757039947, "pro": 0}, "last_reply_by": "squirrelgg", "last_touched": 1758167815, "title": "大家消费降级到什么程度了？", "url": "https://www.v2ex.com/t/1160070", "created": 1758156120, "deleted": 0, "content": "这两年的钱不好挣，花钱的时候也就想着能省则省，以前换季的时候还会想着给自己买两件新衣服，今年却是完全没有这方面的想法了。\r\n\r\n说来也奇了，十年前觉得三百块一件的衣服都不贵，现在就连 50 块钱一件的衣服都舍不得买，再就是以前基本上一年多就要换新手机用，可现在这个手机用了两三年都没有想换掉它的念头。\r\n\r\n这年头钱不好赚，辛辛苦苦赚的钱更要用在刀刃上才行，所以说在购买商品时，优先考虑的应该是这件商品的实用性，而不是它品牌 logo 。\r\n\r\n那么，现如今你有没有开始消费降级，如果有，又是通过什么方式？", "content_rendered": "<p>这两年的钱不好挣，花钱的时候也就想着能省则省，以前换季的时候还会想着给自己买两件新衣服，今年却是完全没有这方面的想法了。</p>\n<p>说来也奇了，十年前觉得三百块一件的衣服都不贵，现在就连 50 块钱一件的衣服都舍不得买，再就是以前基本上一年多就要换新手机用，可现在这个手机用了两三年都没有想换掉它的念头。</p>\n<p>这年头钱不好赚，辛辛苦苦赚的钱更要用在刀刃上才行，所以说在购买商品时，优先考虑的应该是这件商品的实用性，而不是它品牌 logo 。</p>\n<p>那么，现如今你有没有开始消费降级，如果有，又是通过什么方式？</p>\n", "last_modified": 1758156120, "replies": 173, "id": 1160070}, {"node": {"avatar_large": "https://cdn.v2ex.com/navatar/e7b2/4b11/360_large.png?m=1670319927", "name": "windows", "avatar_normal": "https://cdn.v2ex.com/navatar/e7b2/4b11/360_normal.png?m=1670319927", "title": "Windows", "url": "https://www.v2ex.com/go/windows", "topics": 4384, "footer": "", "header": "Windows, not walls.", "title_alternative": "Windows", "avatar_mini": "https://cdn.v2ex.com/navatar/e7b2/4b11/360_mini.png?m=1670319927", "stars": 1360, "aliases": [], "root": false, "id": 360, "parent_node_name": "os"}, "member": {"id": 291158, "username": "Malvo", "url": "https://www.v2ex.com/u/Malvo", "website": "", "twitter": null, "psn": null, "github": null, "btc": null, "location": "", "tagline": "", "bio": "", "avatar_mini": "https://cdn.v2ex.com/avatar/b449/18f9/291158_mini.png?m=1744852263", "avatar_normal": "https://cdn.v2ex.com/avatar/b449/18f9/291158_normal.png?m=1744852263", "avatar_large": "https://cdn.v2ex.com/avatar/b449/18f9/291158_large.png?m=1744852263", "avatar_xlarge": "https://cdn.v2ex.com/avatar/b449/18f9/291158_xlarge.png?m=1744852263", "avatar_xxlarge": "https://cdn.v2ex.com/avatar/b449/18f9/291158_xxlarge.png?m=1744852263", "avatar_xxxlarge": "https://cdn.v2ex.com/avatar/b449/18f9/291158_xxxlarge.png?m=1744852263", "created": 1518224047, "last_modified": 1744852263, "pro": 0}, "last_reply_by": "potatowish", "last_touched": 1758167855, "title": "为什么电脑硬件速度翻了无数倍， Windows 却没更流畅？", "url": "https://www.v2ex.com/t/1159930", "created": 1758089130, "deleted": 0, "content": "有个疑问和大家探讨：  \r\n\r\n从 Windows 98 到 Windows 11 ，这二十多年里，电脑硬件性能已经提升了无数倍。  \r\n- CPU 主频从几百 MHz 到现在动辄 5GHz ，核心数也从单核到十几核；  \r\n- 内存从几十 MB 到如今的几十 GB ；  \r\n- 硬盘从机械盘到 NVMe SSD ，速度提升了成百上千倍；  \r\n- 显卡性能更是跨越式发展。  \r\n\r\n然而，日常使用 Windows 的体验——开机、切换窗口、打开文件、系统动画等等——感觉并没有随着硬件提升产生“质的流畅性飞跃”。  \r\n相反，很多人觉得新版本系统越来越臃肿，反应速度和当年的老系统相比并不轻盈。", "content_rendered": "<p>有个疑问和大家探讨：  </p>\n<p>从 Windows 98 到 Windows 11 ，这二十多年里，电脑硬件性能已经提升了无数倍。  </p>\n<ul>\n<li>CPU 主频从几百 MHz 到现在动辄 5GHz ，核心数也从单核到十几核；  </li>\n<li>内存从几十 MB 到如今的几十 GB ；  </li>\n<li>硬盘从机械盘到 NVMe SSD ，速度提升了成百上千倍；  </li>\n<li>显卡性能更是跨越式发展。  </li>\n</ul>\n<p>然而，日常使用 Windows 的体验——开机、切换窗口、打开文件、系统动画等等——感觉并没有随着硬件提升产生“质的流畅性飞跃”。<br/>\n相反，很多人觉得新版本系统越来越臃肿，反应速度和当年的老系统相比并不轻盈。</p>\n", "last_modified": 1758089130, "replies": 141, "id": 1159930}, {"node": {"avatar_large": "https://cdn.v2ex.com/navatar/4ea0/6fbc/770_large.png?m=1695370146", "name": "career", "avatar_normal": "https://cdn.v2ex.com/navatar/4ea0/6fbc/770_normal.png?m=1695370146", "title": "职场话题", "url": "https://www.v2ex.com/go/career", "topics": 21186, "footer": "", "header": "这里，我们聊聊那些工作中遇到的开心和不开心的事。", "title_alternative": "Career", "avatar_mini": "https://cdn.v2ex.com/navatar/4ea0/6fbc/770_mini.png?m=1695370146", "stars": 3513, "aliases": [], "root": false, "id": 770, "parent_node_name": "work"}, "member": {"id": 644798, "username": "ZettarYuFan", "url": "https://www.v2ex.com/u/ZettarYuFan", "website": null, "twitter": null, "psn": null, "github": null, "btc": null, "location": null, "tagline": null, "bio": null, "avatar_mini": "https://cdn.v2ex.com/avatar/9d15/8e4c/644798_mini.png?m=1692684990", "avatar_normal": "https://cdn.v2ex.com/avatar/9d15/8e4c/644798_normal.png?m=1692684990", "avatar_large": "https://cdn.v2ex.com/avatar/9d15/8e4c/644798_large.png?m=1692684990", "avatar_xlarge": "https://cdn.v2ex.com/avatar/9d15/8e4c/644798_xlarge.png?m=1692684990", "avatar_xxlarge": "https://cdn.v2ex.com/avatar/9d15/8e4c/644798_xxlarge.png?m=1692684990", "avatar_xxxlarge": "https://cdn.v2ex.com/avatar/9d15/8e4c/644798_xxxlarge.png?m=1692684990", "created": 1692684788, "last_modified": 1692684990, "pro": 0}, "last_reply_by": "hillmanpick", "last_touched": 1758167220, "title": "在当前的就业环境下，我刚毕业找到的这份工作算什么水平", "url": "https://www.v2ex.com/t/1160001", "created": 1758101712, "deleted": 0, "content": "如题，我的学历是专升本，22 岁，还是普通学院本，目前工作在贵州贵阳，本人也是贵州人，目前实习找到了一个 8k 双休五险一金的工作，全栈开发，公司主业务是拍摄加无人机，最近需要招开发弄自己的无人机控制平台，顺利进来了，想问问 v 友们后续是苟住还是继续跳，我目前的想法是往公司主业务学习，不想在开发上吊死了", "content_rendered": "<p>如题，我的学历是专升本，22 岁，还是普通学院本，目前工作在贵州贵阳，本人也是贵州人，目前实习找到了一个 8k 双休五险一金的工作，全栈开发，公司主业务是拍摄加无人机，最近需要招开发弄自己的无人机控制平台，顺利进来了，想问问 v 友们后续是苟住还是继续跳，我目前的想法是往公司主业务学习，不想在开发上吊死了</p>\n", "last_modified": 1758101746, "replies": 94, "id": 1160001}, {"node": {"avatar_large": "https://cdn.v2ex.com/navatar/a4a0/42cf/171_large.png?m=1630576706", "name": "invest", "avatar_normal": "https://cdn.v2ex.com/navatar/a4a0/42cf/171_normal.png?m=1630576706", "title": "投资", "url": "https://www.v2ex.com/go/invest", "topics": 2800, "footer": "", "header": "Can you make money with money?", "title_alternative": "Invest", "avatar_mini": "https://cdn.v2ex.com/navatar/a4a0/42cf/171_mini.png?m=1630576706", "stars": 3767, "aliases": [], "root": false, "id": 171, "parent_node_name": "money"}, "member": {"id": 171841, "username": "callmejoejoe", "url": "https://www.v2ex.com/u/callmejoejoe", "website": "", "twitter": "", "psn": "", "github": "callmejoejoe", "btc": "", "location": "深圳", "tagline": "long long way to go.", "bio": "", "avatar_mini": "https://cdn.v2ex.com/avatar/e51e/57d8/171841_mini.png?m=1720150575", "avatar_normal": "https://cdn.v2ex.com/avatar/e51e/57d8/171841_normal.png?m=1720150575", "avatar_large": "https://cdn.v2ex.com/avatar/e51e/57d8/171841_large.png?m=1720150575", "created": 1462440373, "last_modified": 1720150575, "pro": 0}, "last_reply_by": "rickll", "last_touched": 1758167137, "title": "哎，税务局打电话给公司财务，让我去税务局说境外所得的事", "url": "https://www.v2ex.com/t/1160012", "created": 1758104821, "deleted": 0, "content": "https://i.v2ex.co/TJwG27eQl.png\r\n\r\n深圳坂田税务所\r\n\r\n几个月前就打过电话，我随便申报了，结果今天直接打到公司财务座机上，让我过去一趟。\r\n\r\n之前一直没通知，等到现在才通知，还要交滞纳金，执行的具体法规都没有，感觉太不公正了。\r\n\r\n请问有已经去过的老哥吗？该怎么说呢？那些盈利的还好，顶多是少赚点，但我们这种亏的还要交，实在憋屈，能否多年合并计算？查了一下，其他国家资本亏损可以结转，天朝是否可行？\r\n\r\n我的情况是：\r\n- 21/22 年炒中概大亏，23 靠美股回血 24 万，24 年靠美股回血 12 万，24 年底玩牛熊证又亏回去了，富途总盈亏-9 万。\r\n- 交易太频繁了，月结单根本算不过来。\r\n- 目前已换到盈透，不知道是否还会不会被税。\r\n- 应该是去年玩牛熊证触发的？交易额有 1000 多万港币\r\n\r\n哎", "content_rendered": "<a target=\"_blank\" href=\"/i/TJwG27eQl.png\" rel=\"nofollow noopener\" target=\"_blank\" title=\"在新窗口打开图片 TJwG27eQl.png\"><img src=\"//i.v2ex.co/TJwG27eQl.png\" class=\"embedded_image\"></a><br /><br />深圳坂田税务所<br /><br />几个月前就打过电话，我随便申报了，结果今天直接打到公司财务座机上，让我过去一趟。<br /><br />之前一直没通知，等到现在才通知，还要交滞纳金，执行的具体法规都没有，感觉太不公正了。<br /><br />请问有已经去过的老哥吗？该怎么说呢？那些盈利的还好，顶多是少赚点，但我们这种亏的还要交，实在憋屈，能否多年合并计算？查了一下，其他国家资本亏损可以结转，天朝是否可行？<br /><br />我的情况是：<br />- 21/22 年炒中概大亏，23 靠美股回血 24 万，24 年靠美股回血 12 万，24 年底玩牛熊证又亏回去了，富途总盈亏-9 万。<br />- 交易太频繁了，月结单根本算不过来。<br />- 目前已换到盈透，不知道是否还会不会被税。<br />- 应该是去年玩牛熊证触发的？交易额有 1000 多万港币<br /><br />哎", "last_modified": 1758152280, "replies": 71, "id": 1160012}, {"node": {"avatar_large": "https://cdn.v2ex.com/navatar/a3c6/5c29/108_large.png?m=1691642161", "name": "bb", "avatar_normal": "https://cdn.v2ex.com/navatar/a3c6/5c29/108_normal.png?m=1691642161", "title": "宽带症候群", "url": "https://www.v2ex.com/go/bb", "topics": 17875, "footer": "", "header": "网速很重要。比快更快。", "title_alternative": "Broadband Symptom Complex", "avatar_mini": "https://cdn.v2ex.com/navatar/a3c6/5c29/108_mini.png?m=1691642161", "stars": 8013, "aliases": [], "root": false, "id": 108, "parent_node_name": "geek"}, "member": {"id": 252115, "username": "asuka321", "url": "https://www.v2ex.com/u/asuka321", "website": "", "twitter": "", "psn": "", "github": "", "btc": "", "location": "", "tagline": "", "bio": "", "avatar_mini": "https://cdn.v2ex.com/gravatar/7d698cc2cae171a9c9aa750a9810d929?s=24&d=retro", "avatar_normal": "https://cdn.v2ex.com/gravatar/7d698cc2cae171a9c9aa750a9810d929?s=48&d=retro", "avatar_large": "https://cdn.v2ex.com/gravatar/7d698cc2cae171a9c9aa750a9810d929?s=73&d=retro", "created": 1504338129, "last_modified": 1758086522, "pro": 0}, "last_reply_by": "csfreshman", "last_touched": 1758167425, "title": "家庭网络设计方案：从理想到实践的两年演进", "url": "https://www.v2ex.com/t/1159920", "created": 1758087894, "deleted": 0, "content": "原文发布在[我的博客]( https://yanliang.life/posts/home/%E5%AE%B6%E5%BA%AD%E6%95%B4%E4%BD%93%E7%BD%91%E7%BB%9C%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/)\r\n\r\n# 前言\r\n早在毕业后的租房时期，我就时常期待拥有自己的家后要如何改造家庭网络。每次看到网上博主分享内网万兆传输、服务器机柜、NAS 阵列等内容，都不禁心生羡慕。2023 年新家入住后，我对家庭网络的改造断断续续持续了两年。到了 2025 年，终于是时候对这段历程做一些总结了。\r\n\r\n这篇文章将重点回顾这两年来家庭网络结构的演进过程及背后的思考。\r\n\r\n# 房屋结构和网络需求\r\n房屋为精装交付，出于成本考虑，入住时未对结构进行大幅改造。简略结构如下：\r\n\r\n![房屋结构]( https://i.imgur.com/UI7HN9m.png)\r\n\r\n入住前暴露的主要问题有以下几点：\r\n\r\n1. 弱电箱嵌入在进门鞋柜内，空间非常有限，难以容纳较多设备，散热也较差。\r\n2. 网口数量不足，无线 AP 只能放置在客厅，书房存在 WiFi 死角。\r\n3. 预埋网线为超五类，虽然短距离可支持万兆，但稳定性不佳。\r\n\r\n我对家庭网络能力的主要需求如下：\r\n\r\n| 需求              | 必要性 | 备注 |\r\n| ---------        | ----------- | ----------- |\r\n| 全屋透明代理       | ⭐⭐⭐⭐⭐       | 满足全屋代理的同时，需要过滤 PT 流量/大陆域名请求等\r\n| 内网 2.5G 速率      | ⭐⭐⭐⭐⭐        | 综合考虑，部署万兆的成本过高，日常使用 2.5G 已够使用\r\n| 内网穿透          | ⭐⭐⭐⭐          | 游戏联机/家庭相册共享需要\r\n| 支持内网私有域名    | ⭐⭐⭐⭐         | 简化日常内网部署应用的使用\r\n| 网络监控/恢复能力   | ⭐⭐⭐          | 提升故障问题发现率\r\n| 智能家居内网部署  | ⭐⭐              | 提升响应速度并支持离线使用\r\n| 隐私设备子网隔离 | ⭐⭐            | 摄像头、传感器类 iot 设备屏蔽公网\r\n| 容灾能力          | ⭐             | 减少故障发生后的恢复时间\r\n\r\n基于以上的需求，得到以下的初步结论\r\n1. 由于需要全屋透明代理，故需要使用软路由做主路由的方案，这里我选用 OpenWrt 作为我的软路由系统。\r\n2. 由于需要全屋 2.5G 速率，硬件上交换机/AP/设备网口均需要支持 2.5G 协商速率。（被只支持 1G 和 10G 的万兆卡坑过）\r\n3. 由于需要内网穿透+私有域名等需求，需要软路由系统有相关的功能支持.(关注版本功能)\r\n4. 由于需要智能家居内网部署，购买设备时需要关注是否支持 Zigbee / Matter 等协议。\r\n\r\n# 2023 年：从零搭建，先跑起来\r\n\r\n## 物理拓扑\r\n2023 年的主题是建设，在入住后不久，我便设计了如下的网络拓扑：\r\n![]( https://i.imgur.com/tOAcZrP.png)\r\n\r\n可以看到这里用了不太常见的单臂路由作为主路由连接方案，并不是因为软路由只有一个网口，纯粹是当时考虑如果软路由放在弱电箱内散热不太好。\r\n\r\n我的主要网络设备如下：\r\n* 软路由：零刻 EQ12(n100/16G)\r\n* 交换机：TP-LINK 网管交换机 + 水星非网管交换机\r\n* 无线 ap：小米 AX7000\r\n* 服务器：X11SCA-F + E2144G + 64G ECC\r\n\r\n硬件配置上普普通通，甚至有些富裕。当然，在闲鱼淘的交换机还是带起了后续的一些变化（笑\r\n\r\n## 系统架构\r\n\r\n系统架构如下图所示\r\n![]( https://i.imgur.com/JxPlsjZ.jpeg)\r\n\r\n### 软路由\r\n\r\n我在 ESXi 上虚拟化运行 OpenWrt ，主要出于以下考虑：\r\n1. 部署便利：套一层虚拟机便于在更改网络配置时不需要进行物理空间内的布线调整。\r\n2. 容灾能力：ESXi 有完善的备份还原机制，通过备份可以快速恢复网络配置。\r\n3. 性能考虑：觉得软路由性能过剩，除了 OpenWrt 还可以安装其他的系统（这点后来证明并不现实）。\r\n4. 熟悉程度：相比 PVE 来说对 ESXi 更熟悉一些\r\n\r\nOpenWrt 使用了来自恩山的“高大全”版本，后来发现其中大部分功能并未用到，反而偶尔引发卡顿。\r\n\r\nHomeAssistant 直接部署在软路由中，主要原因一是软路由设备先于服务器购买，出于调教智能家居设备的原因先安装在软路由内。二是 HA 需要安装 HAOS 才能安装插件（即必须是虚拟机版本，不能部署在容器内），当时认为 TrueNAS 的虚拟机能力并没有 ESXi 好，所以服务器买来后也没有进行迁移（后来发现 N100 性能根本无法与 E-2144G 相比😅）\r\n\r\n### 服务器\r\n\r\n2023 年 618 ，我筹备组建第一台服务器，当时我对服务器的主要需求是以下几点：\r\n1. 是一台偏存储的服务器，多盘位存储且支持 SAS 硬盘。\r\n2. 支持 ecc 内存。\r\n3. 带核显，支持视频硬解。\r\n4. 支持 RAID 。\r\n5. 可以装虚拟机/容器。\r\n\r\n在淘了比较久的垃圾后，最终选用的配置如下：\r\n* 主板: 超微 X11SCA-F\r\n* CPU: Intel E-2144G\r\n* 内存: 三星 DDR4 2666 ECC 32G*2 \r\n* 硬盘: 希捷酷鹰 4T*4\r\n* 网卡: 迈络思 MCX311A\r\n* 机箱: 半人马座\r\n* 电源: 海韵 SGX500\r\n\r\n![]( https://i.imgur.com/rmPYHfs.jpeg)\r\n\r\n这套配置里，最先选择的是机箱，因为家里没有位置放置机柜，想要多盘位又不想装较大的塔式机箱，最终入了半人马的机箱，颜值和扩展相对不错。\r\n\r\nCPU 上，2144g 的性能和能耗较为平衡，且核显有 QSV 能力，能加速视频编解码，主频 3.6 睿频 4.5 也能较好的应付日常的计算工作。\r\n![]( https://i.imgur.com/mH79FjI.png)\r\n\r\n内存上由于心心念念一直想要搞一套 ecc 内存，这次选用了三星的 ddr4 2666 的纯 ecc 内存条(24 年还坏了一根😭)。\r\n\r\n这套配置有几个小插曲，一是网卡一开始买的浪潮电口 X540, 没想到居然不支持 2.5G 协商速率，害的我又重新买了一块。二是由于机箱比较小，虽然能装 atx 板，但硬盘接口的位置都被挡住了，没办法后续加装了一块 SAS 直通卡解决。\r\n\r\n在系统上，由于是偏存储的服务器，系统更偏向选择一些具备 nas 功能的系统，在 Unraid/TrueNAS 等一众 nas 系统及 linux 原生/虚拟机系统的抉择下，我最终选择了以 TrueNAS 作为我的服务器系统，理由主要是以下几点:\r\n1. 相比 Unraid 等 NAS 系统，TrueNAS 使用 ZFS 文件系统，有完善的数据验证、快照、恢复等机制。\r\n2. 相比直接部署 linux 系统, TrueNAS 上有更易上手的 RAID 管理/监控等能力。\r\n3. 相比部署虚拟机系统，如 ESXi 或 proxmox ，由于 TrueNAS scale 已经支持了虚拟机和容器，我不需要再加一层套娃。\r\n\r\nRAID 方面，我的 4 块 4T 酷鹰组了 RAIDZ1(类似 RAID5)，实际容量在 10T 左右，确保在一块坏了的时候能够不丢失数据恢复。\r\n\r\n软件服务方面，我部署了以下的服务：\r\n* qBittorrent：PT 下载。\r\n* Homepage: 家庭服务仪表盘。\r\n* icloudpd: 同步 iCloud 照片\r\n* Jellyfin: 媒体服务器。\r\n* TinyMediaManager: 影视元数据刮削。\r\n* PhotoPrism: 照片管理\r\n\r\n### 智能家居\r\n作为 ios 用户，加上购买了 AppleTv 、HomePod 等一些设备，智能家居生态自然选择了 Apple 的 HomeKit 。主要设备有:\r\n\r\n* 网关: Aqara M1S/HomePod\r\n* 开关: Aqara D1\r\n* 空调控制: 郎宁 VRF\r\n* 窗帘电机: Aqara\r\n* 传感器: 小米人体传感器\r\n* 门锁: 小米智能门锁\r\n* 电视: AppleTv\r\n\r\nAqara 设备通过网关直接接入 HomeKit ，小米设备则通过 HomeAssistant 桥接接入。\r\n\r\n# 2024 年: 问题浮现与系统优化\r\n\r\n## 遇到的问题\r\n\r\n2023 年的架构基本稳定运行至 2024 上半年，期间虽然偶尔出现 PT 流量误走代理、OpenClash 卡死等问题，但尚可接受。\r\n\r\n然而以上的拓扑存在一个致命的缺陷: **弱电箱中的网管交换机成为单点故障**。一旦损坏，替换过程极为繁琐，需重新配置 VLAN ，且端口顺序必须与原配置一致。\r\n\r\n而就在 2024 年的 5 月某天，那台网管交换机突然宕机了，我在重新下单等了 2 天收到货后开始配置，才发现完全不记得之前的 VLAN 设置了。当时正值 618 之际，在每天晚上下班仅有的 2 个小时内，花了 2 天才将家庭网络恢复如初。这促使我决心进行网络改造，重点是**稳定性和容灾能力**\r\n\r\n## 链路可用性分析\r\n\r\n既然要增强系统稳定性及容灾能力，那么首先需要梳理一下目前的网络链路以及相关的可用性需求。\r\n\r\n\r\n| 链路                      | 可用性需求        | 达到可用时的最少设备           | 达到可用时的最少系统组件 |\r\n| -----------------         | --------        | --------                    |  -------- |\r\n| 国内访问（部分设备）\t    |⭐⭐⭐⭐⭐       | 路由器                      | 无\r\n| 无线连接\t             |⭐⭐⭐⭐          | 路由器、AP               |无\r\n| 书房有线连接            |⭐⭐⭐⭐          | 路由器、弱电箱到书房网线       |无\r\n| 客厅有线连接\t          |⭐⭐⭐⭐          | 路由器、弱电箱到客厅网线       |无\r\n| 国际访问（部分设备）\t   |⭐⭐⭐            | 路由器                      |OpenClash\r\n| PC 网络\t             |⭐⭐⭐           | 路由器、PC                  |无\r\n| 服务器网络              |⭐⭐             | 路由器、服务器               |无\r\n| 智能家居可用            |⭐⭐              | 路由器、交换机、智能家居网关   |HomeAssistant\r\n| 全设备国内访问\t      |⭐⭐             | 路由器、交换机、AP          |无\r\n| 全设备国际访问          |⭐⭐             | 软路由设备、交换机、AP       |OpenClash\r\n| 内网穿透               |⭐              |软路由设备                     | 阿里 DDNS 、域名服务\r\n\r\n其次，需要梳理一下网络中可能故障的节点以及其挂了后的影响面。对影响面的评估我分了以下几级：\r\n\r\n- 致命: 对网络可用性或完整性产生重大影响，且无法通过备用设备进行快恢。\r\n- 严重: 对网络可用性或完整性产生较大影响，但可以通过备用设备或降级部分功能完成核心功能恢复。\r\n- 一般: 对网络可用性或完整性产生影响，但有备用链路可以使用，或允许接受功能降级的情况。\r\n- 轻微: 有轻微体验影响的情况\r\n\r\n先列举一下物理设备可能的故障:\r\n\r\n|故障节点                  | 故障影响      |应急措施                          | 监测手段 |\r\n|------------------       | ------      | --------                                          |  -------- |\r\n|书房至弱电箱网线故障        | 致命         | 书房的有线网络失效，需要额外引入书房 ap 连入客厅 ap 进行上网   | 无有效手段 |\r\n|客厅至弱电箱网线故障        | 致命         | 无线 ap 迁移至弱电箱内或书房，无线信号会受影响              | 无有效手段 |\r\n|软路由设备故障             | 严重          | 软路由设备临时替换为普通路由器拨号上网                 | 通过 ESXi 和 OpenWrt 探活可知，但实际确认需要线下 |\r\n|弱电箱内交换机故障          | 严重         | 替换备用交换机                                    | 无有效手段(原网管交换机有后台可以探活，但非网管的一般没有) |\r\n|书房交换机故障             |  严重         | 替换备用交换机                                    |  无有效手段(同上) |\r\n|服务器设备故障                 | 严重         | 无通用方案，根据故障情况处理                             | 软路由内部署脚本进行探活 |\r\n|智能家居网关故障            | 严重         | 无应急方案                                            |  HA 主动进行的设备探活 |\r\n|无线 AP 故障                 | 严重        | 替换备用 ap                                            |  通过无线 ap 的端口探活 |\r\n\r\n然后是系统组件的可能的故障:\r\n\r\n| 故障节点             | 故障影响 | 应急措施                                                    | 监测手段                                                   |\r\n| -------------------- | -------- | -------------------------------------------------------| ---------------------------------------------------------- |\r\n| ESXi 故障           | 严重     | 若重启无法失效需要替换为普通路由器拨号上网                        | 通过 ESXi 管理端口探活                   |\r\n| OpenWrt 故障        | 严重     | exsi 内通过备份快照快速恢复即可                                 | 通过 OpenWrt 管理端口探活      |\r\n| TrueNAS 故障        | 严重      | 需要重装系统，管理配置通过备份恢复                                | 软路由内部署脚本进行探活              |\r\n| OpenClash 故障      | 一般     |  重启或降级                                                   | 通过 OpenClash 端口探活 |\r\n| HomeAssistant 故障  | 一般     |  exsi 内通过备份快照快速恢复即可                                   | 通过 HA 端口探活 |\r\n| DDNS 故障          | 轻微       | 重启/手动更新 IP   | 无有效手段                                         |\r\n\r\n## 物理拓扑的调整\r\n根据上述的可用性优先级，我将物理拓扑图变成了这样:\r\n\r\n![2024-网络拓扑]( https://i.imgur.com/IYo290f.png)\r\n\r\n从物理拓扑上来看，改变不算特别大，仅是将路由器从书房移回了弱电箱，但从稳定性的角度考虑，这一项调整让家庭减少了 2 个强依赖项，一个就是网管交换机，就算挂了我也可以替换为普通交换机，甚至不用交换机直连客厅 AP,也能保证局部的网络可用。另一个就是去除了弱电箱到书房的网线这个强依赖，一旦网线出问题，仅需降级书房的有线网络即可保障部分可用性。\r\n\r\n至于软路由的散热问题，一来在这一年的使用过程中，温度还算可控。二来我买了一个 usb 温控风扇贴着吹进行散热，整体评估放在弱电箱内问题不大。（是吗=。=）\r\n\r\n## 系统架构的升级\r\n在系统拓扑方面，改造的东西就相对较多一些了，在聊改造细节之前，我们还是先来看看当下遇到的问题有哪些：\r\n\r\n1. 由于 OpenClash 的性能问题，导致间歇性的断网。\r\n2. 当 OpenClash 的目标节点异常时没有主动感知，在连不上外网或者速度很慢时才能发现进行切换。\r\n3. PT 流量会经过代理服务器导致流量耗尽。\r\n4. 所有数据共用一个磁盘组，PT 和重要数据的区分不够，有数据丢失风险，重要数据没有备份机制。\r\n5. 网络的整体监控能力较弱，出现问题无法溯源。\r\n6. 缺少各关键节点的容灾能力。\r\n\r\n为了解决以上的问题，系统的拓扑变成了这样：\r\n\r\n![2024-网络拓扑]( https://i.imgur.com/bnxjsuU.png)\r\n\r\n## 软路由内的调整\r\n\r\n由上图所示，软路由内最大的一个改变，就是将 OpenClash 从拨号的 OpenWrt 内剥离了出去，并将拨号用的 OpenWrt 更改为了自编译的精简版本，插件只包含了阿里 ddns 和 mosdns ，其中阿里 ddns 用于内网穿透，而 mosdns 用做代理分流使用。\r\n\r\n首先需要说明一下这样调整后的网络请求顺序，为方便说明，拨号用的 OpenWrt 简称为 A ，OpenClash 所在的 OpenWrt 简称 B：\r\n\r\n![]( https://i.imgur.com/EHPRHpb.png)\r\n\r\n如图所示，在这种网络链路下，国内请求不会经过 OpenClash ，同时为了控制 OpenClash 影响的 CPU 和内存范围，我选择在 ESXi 内单独起了一个虚拟机，用 ESXi 进行最大 CPU 和内存的限制，尽可能做到在 OpenClash 异常时不会耗尽整个路由器资源。至于为什么要再套一层 OpenWrt 而不是直接部署 OpenClash ，那是为了后续有其他插件需要安装时也可以从主链路中剥离开。\r\n\r\n而在 2024 年，为什么我还将 HomeAssistant 部署在软路由内，原因是当时高估了软路由的性能，并且因为担心服务器挂了可能会影响智能家居设备=.=\r\n\r\n## 服务器的调整\r\n\r\n首先提一下硬件上的调整(上图中没展示出来)，由于需要按资料重要性进行资源隔离，我新增了 2 块二手 12T 的氦气盘组了 RAID 1 阵列，高频读写的 PT 、影音等数据存在这个阵列内，原先的阵列用来存放家庭照片、数据备份、文档备份等。\r\n\r\n然后是服务器内部署的一些应用进行了调整:\r\n+ 移除 Jellyfin：由于我没有在外看视频的需求，在家的话不需要在服务器上进行解码，直接传流手机解码即可，最终方案是在手机和电视上安装了 infuse 作为媒体观看软件。\r\n+ PhotoPrism 替换为 MTPhotos: PhotoPrism 属实难用。\r\n+ 新增 Alist （网盘管理）、Calibre （电子书管理）。\r\n+ 部署 Ubuntu 虚拟机: 用来部署相关的监控脚本。\r\n+ 计划上会添加上 prometheus+grafana 作为监控套件，但实际 2024 年并未添加\r\n\r\n在增强稳定性方面，服务器上的脚本担任了绝大多数的任务需求，整个监控体系如下图所示:\r\n![]( https://i.imgur.com/t1CSCHN.png)\r\n\r\n其中的脚本都是非常简单的 shell 脚本，通过 http 请求对应服务的管理接口，有数据就当有心跳。这里可以看出当时的一个观点：只要不挂都不是大问题（笑）。但这套体系还是有不少的监控盲区和问题，最显而易见的，就是当 OpenWrt 或者 ESXi 挂了的时候，push 消息根本发不出来（这个问题居然一直到了 25 年才被反应过来）\r\n\r\n# 2025 年: 体系化与稳定性建设\r\n\r\n## 发现问题\r\n\r\n上述调整后的架构完美运行了很长时间，期间没有发生任何大问题，偶尔的 clash 异常也能在重启后恢复。但没出大问题也就意味着上述的降级容灾措施并没有被实际验证过。\r\n\r\n时间来到 2025 年的夏天，某个周末开始网络会时不时出现卡顿，一开始还以为是 PT 下载的缘故，由于持续时间不长就没太关注。但慢慢的卡顿频率越来越多，有时候 OpenWrt 的 CPU 占用会飙升到 100%，排查发现 OpenWrt 内 CPU 占用最高的线程是 ksoftirqd ，ksoftirqd 是一个处理软中断的线程，它占 CPU 高往往是结果而不是原因。深入排查发现在弱电箱内的软路由在正常情况下就烫的厉害，那会不会是因为软路由散热不好导致 CPU 降频或网卡异常进而触发了软中断爆炸呢，在换了一个更大的散热风扇后，这个情况再没有发生。\r\n\r\n这个事件让我看到了 2 个问题：\r\n\r\n1. 现有监控无法捕捉瞬时异常，缺乏历史数据追踪。\r\n2. 软路由的负载过高，需进一步划清设备职责。\r\n\r\n这样下来，2025 年的改造目标，重点就是：\r\n\r\n**建设体系化监控+设备能力单一化**\r\n\r\n## 监控体系升级\r\n\r\n其实在 2024 年的规划中，就已经画出了 grafana+prometheus 的套件组合，但由于 prometheus 过于原始的配置方式，加上当时认为脚本探活就可以完成家庭网络的监控工作，这 2 者并没有被使用起来。\r\n\r\n回到现在，监控体系还是选择使用 grafana+prometheus 的组合，毕竟开源解决方案很多。安装后的效果如下。\r\n\r\n![]( https://i.imgur.com/8znNMf2.png)\r\n\r\n关于 prometheus exporter 的选择，目前是这样的:\r\n\r\n| 监控节点              |  拉取速度     | 核心关注指标                                      |exporter 来源|\r\n|------------------   | ------      | --------                                          | --------          |\r\n|OpenWrt              | 5s          | CPU 使用率、内存使用率、load 、网络 io 、活跃连接数                    | OpenWrt 软件包内自带         |\r\n|HomeAssistant      | 30s           | 设备电池电量、空调使用时间                                         | HA 插件                                                  |\r\n|TrueNAS            | 5s      | CPU 使用率、内存使用率、load 、磁盘 io 、网络 io|  https://github.com/Supporterino/TrueNAS-graphite-to-prometheus   |\r\n|qBittorrent        | 60s        | 下载/上传速度、做种数                                             |  自建                 |\r\n|OpenClash          | 20s         | 下载/上传速度、流量使用量、活跃连接数、国内/国际 ping 延时            |  自建                 |\r\n\r\n需要提的是为什么没有 ESXi 的 exporter ，原因是不想为了监控再装一个 vCenter 了=。=\r\n\r\n## 日志\r\n\r\n> 日志及下述单一化的部分在这篇文章写作之时并没有完全调整完成，这里主要说一下我的方案。\r\n\r\n既然监控使用了 grafana ，日志当然使用 promtail+loki 的配套搭配，但看了文档发现 promtail 目前已经被弃用了，替代者是 alloy ，所以整个的日志方案就变成了 alloy(日志采集)+loki(日志存储)+grafana(日志看板)的组合拳。\r\n\r\nTrueNAS 内的日志采集直接部署 alloy 应用即可，日志基本集中在/var/log 目录下，我目前是采集了/var/log/containers/*和/var/log/syslog.log 用以监控应用和系统的关键日志。\r\n\r\nOpenWrt 的日志采集，我决定参考 [github]( https://github.com/defanator/openwrt-loki-exporter?tab=readme-ov-file) 的方案在 OpenWrt 内直接部署日志上报的功能。\r\n\r\nESXi 和 HomeAssistant 暂不接入。\r\n\r\n## 设备职责单一化\r\n\r\n在软件工程里，KISS 原则是一个非常重要的工程实践方法。回看前两年迭代的结构演进，有哪些地方违法了 KISS 原则呢？\r\n\r\n1. 为了减少 OpenClash 对系统的影响，引入了 mosdns 进入主链路。\r\n2. 软路由内部署了 HomeAssistant 。\r\n3. 存储服务器承担了越来越多的计算工作。\r\n\r\n要如何解决这 3 个问题呢，我目前的方案如下：\r\n\r\n关于问题 1, 当我在 2025 年再次审视 clash 的配置时，发现其实 clash 本身就支持 dns 分流及按配置绕过内核，引入 mosdns 似乎并不需要，于是我将 2 个 OpenWrt 再次删减为一个，仅使用 OpenClash 的规则配置进行流量分流，这个方案带来的唯一问题可能 CPU 会被 clash 吃满，但这通过监控也可以完成 clash 自动启停。关于 clash 的配置，github 上的[这个仓库]( https://github.com/Aethersailor/Custom_OpenClash_Rules)有非常详尽的教学，可以参考。\r\n\r\n关于问题 2, 很好解决，我将 HomeAssistant 从软路由迁移至服务器。\r\n\r\n关于问题 3 ，这实际是个成本问题（哈哈）。随着监控和日志系统的完善，我计划观察一段时间服务器使用，如果确实日常计算量很高，可能会考虑增加一台专用计算的设备保障存储设备的稳定性。（比如 mac mini ）\r\n\r\n# 最后\r\n\r\n家庭网络的建设是一个持续迭代的过程，从最初的“能用到”到“稳定用”，再到“高效与可观测”，每一个阶段都伴随着新的挑战与解决方案。本文重点分享了设计思路与架构演进，具体技术细节将在后续文章展开。如果你也正在构建家庭网络，希望本文能为你提供一些参考。", "content_rendered": "<p>原文发布在<a href=\"https://yanliang.life/posts/home/%E5%AE%B6%E5%BA%AD%E6%95%B4%E4%BD%93%E7%BD%91%E7%BB%9C%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/\" rel=\"nofollow\">我的博客</a></p>\n<h1>前言</h1>\n<p>早在毕业后的租房时期，我就时常期待拥有自己的家后要如何改造家庭网络。每次看到网上博主分享内网万兆传输、服务器机柜、NAS 阵列等内容，都不禁心生羡慕。2023 年新家入住后，我对家庭网络的改造断断续续持续了两年。到了 2025 年，终于是时候对这段历程做一些总结了。</p>\n<p>这篇文章将重点回顾这两年来家庭网络结构的演进过程及背后的思考。</p>\n<h1>房屋结构和网络需求</h1>\n<p>房屋为精装交付，出于成本考虑，入住时未对结构进行大幅改造。简略结构如下：</p>\n<p><img alt=\"房屋结构\" class=\"embedded_image\" loading=\"lazy\" referrerpolicy=\"no-referrer\" rel=\"noreferrer\" src=\"https://i.imgur.com/UI7HN9m.png\"/></p>\n<p>入住前暴露的主要问题有以下几点：</p>\n<ol>\n<li>弱电箱嵌入在进门鞋柜内，空间非常有限，难以容纳较多设备，散热也较差。</li>\n<li>网口数量不足，无线 AP 只能放置在客厅，书房存在 WiFi 死角。</li>\n<li>预埋网线为超五类，虽然短距离可支持万兆，但稳定性不佳。</li>\n</ol>\n<p>我对家庭网络能力的主要需求如下：</p>\n<table>\n<thead>\n<tr>\n<th>需求</th>\n<th>必要性</th>\n<th>备注</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>全屋透明代理</td>\n<td>⭐⭐⭐⭐⭐</td>\n<td>满足全屋代理的同时，需要过滤 PT 流量/大陆域名请求等</td>\n</tr>\n<tr>\n<td>内网 2.5G 速率</td>\n<td>⭐⭐⭐⭐⭐</td>\n<td>综合考虑，部署万兆的成本过高，日常使用 2.5G 已够使用</td>\n</tr>\n<tr>\n<td>内网穿透</td>\n<td>⭐⭐⭐⭐</td>\n<td>游戏联机/家庭相册共享需要</td>\n</tr>\n<tr>\n<td>支持内网私有域名</td>\n<td>⭐⭐⭐⭐</td>\n<td>简化日常内网部署应用的使用</td>\n</tr>\n<tr>\n<td>网络监控/恢复能力</td>\n<td>⭐⭐⭐</td>\n<td>提升故障问题发现率</td>\n</tr>\n<tr>\n<td>智能家居内网部署</td>\n<td>⭐⭐</td>\n<td>提升响应速度并支持离线使用</td>\n</tr>\n<tr>\n<td>隐私设备子网隔离</td>\n<td>⭐⭐</td>\n<td>摄像头、传感器类 iot 设备屏蔽公网</td>\n</tr>\n<tr>\n<td>容灾能力</td>\n<td>⭐</td>\n<td>减少故障发生后的恢复时间</td>\n</tr>\n</tbody></table><p>基于以上的需求，得到以下的初步结论</p>\n<ol>\n<li>由于需要全屋透明代理，故需要使用软路由做主路由的方案，这里我选用 OpenWrt 作为我的软路由系统。</li>\n<li>由于需要全屋 2.5G 速率，硬件上交换机/AP/设备网口均需要支持 2.5G 协商速率。（被只支持 1G 和 10G 的万兆卡坑过）</li>\n<li>由于需要内网穿透+私有域名等需求，需要软路由系统有相关的功能支持.(关注版本功能)</li>\n<li>由于需要智能家居内网部署，购买设备时需要关注是否支持 Zigbee / Matter 等协议。</li>\n</ol>\n<h1>2023 年：从零搭建，先跑起来</h1>\n<h2>物理拓扑</h2>\n<p>2023 年的主题是建设，在入住后不久，我便设计了如下的网络拓扑：\n<img alt=\"\" class=\"embedded_image\" loading=\"lazy\" referrerpolicy=\"no-referrer\" rel=\"noreferrer\" src=\"https://i.imgur.com/tOAcZrP.png\"/></p>\n<p>可以看到这里用了不太常见的单臂路由作为主路由连接方案，并不是因为软路由只有一个网口，纯粹是当时考虑如果软路由放在弱电箱内散热不太好。</p>\n<p>我的主要网络设备如下：</p>\n<ul>\n<li>软路由：零刻 EQ12(n100/16G)</li>\n<li>交换机：TP-LINK 网管交换机 + 水星非网管交换机</li>\n<li>无线 ap：小米 AX7000</li>\n<li>服务器：X11SCA-F + E2144G + 64G ECC</li>\n</ul>\n<p>硬件配置上普普通通，甚至有些富裕。当然，在闲鱼淘的交换机还是带起了后续的一些变化（笑</p>\n<h2>系统架构</h2>\n<p>系统架构如下图所示\n<img alt=\"\" class=\"embedded_image\" loading=\"lazy\" referrerpolicy=\"no-referrer\" rel=\"noreferrer\" src=\"https://i.imgur.com/JxPlsjZ.jpeg\"/></p>\n<h3>软路由</h3>\n<p>我在 ESXi 上虚拟化运行 OpenWrt ，主要出于以下考虑：</p>\n<ol>\n<li>部署便利：套一层虚拟机便于在更改网络配置时不需要进行物理空间内的布线调整。</li>\n<li>容灾能力：ESXi 有完善的备份还原机制，通过备份可以快速恢复网络配置。</li>\n<li>性能考虑：觉得软路由性能过剩，除了 OpenWrt 还可以安装其他的系统（这点后来证明并不现实）。</li>\n<li>熟悉程度：相比 PVE 来说对 ESXi 更熟悉一些</li>\n</ol>\n<p>OpenWrt 使用了来自恩山的“高大全”版本，后来发现其中大部分功能并未用到，反而偶尔引发卡顿。</p>\n<p>HomeAssistant 直接部署在软路由中，主要原因一是软路由设备先于服务器购买，出于调教智能家居设备的原因先安装在软路由内。二是 HA 需要安装 HAOS 才能安装插件（即必须是虚拟机版本，不能部署在容器内），当时认为 TrueNAS 的虚拟机能力并没有 ESXi 好，所以服务器买来后也没有进行迁移（后来发现 N100 性能根本无法与 E-2144G 相比😅）</p>\n<h3>服务器</h3>\n<p>2023 年 618 ，我筹备组建第一台服务器，当时我对服务器的主要需求是以下几点：</p>\n<ol>\n<li>是一台偏存储的服务器，多盘位存储且支持 SAS 硬盘。</li>\n<li>支持 ecc 内存。</li>\n<li>带核显，支持视频硬解。</li>\n<li>支持 RAID 。</li>\n<li>可以装虚拟机/容器。</li>\n</ol>\n<p>在淘了比较久的垃圾后，最终选用的配置如下：</p>\n<ul>\n<li>主板: 超微 X11SCA-F</li>\n<li>CPU: Intel E-2144G</li>\n<li>内存: 三星 DDR4 2666 ECC 32G*2 </li>\n<li>硬盘: 希捷酷鹰 4T*4</li>\n<li>网卡: 迈络思 MCX311A</li>\n<li>机箱: 半人马座</li>\n<li>电源: 海韵 SGX500</li>\n</ul>\n<p><img alt=\"\" class=\"embedded_image\" loading=\"lazy\" referrerpolicy=\"no-referrer\" rel=\"noreferrer\" src=\"https://i.imgur.com/rmPYHfs.jpeg\"/></p>\n<p>这套配置里，最先选择的是机箱，因为家里没有位置放置机柜，想要多盘位又不想装较大的塔式机箱，最终入了半人马的机箱，颜值和扩展相对不错。</p>\n<p>CPU 上，2144g 的性能和能耗较为平衡，且核显有 QSV 能力，能加速视频编解码，主频 3.6 睿频 4.5 也能较好的应付日常的计算工作。\n<img alt=\"\" class=\"embedded_image\" loading=\"lazy\" referrerpolicy=\"no-referrer\" rel=\"noreferrer\" src=\"https://i.imgur.com/mH79FjI.png\"/></p>\n<p>内存上由于心心念念一直想要搞一套 ecc 内存，这次选用了三星的 ddr4 2666 的纯 ecc 内存条(24 年还坏了一根😭)。</p>\n<p>这套配置有几个小插曲，一是网卡一开始买的浪潮电口 X540, 没想到居然不支持 2.5G 协商速率，害的我又重新买了一块。二是由于机箱比较小，虽然能装 atx 板，但硬盘接口的位置都被挡住了，没办法后续加装了一块 SAS 直通卡解决。</p>\n<p>在系统上，由于是偏存储的服务器，系统更偏向选择一些具备 nas 功能的系统，在 Unraid/TrueNAS 等一众 nas 系统及 linux 原生/虚拟机系统的抉择下，我最终选择了以 TrueNAS 作为我的服务器系统，理由主要是以下几点:</p>\n<ol>\n<li>相比 Unraid 等 NAS 系统，TrueNAS 使用 ZFS 文件系统，有完善的数据验证、快照、恢复等机制。</li>\n<li>相比直接部署 linux 系统, TrueNAS 上有更易上手的 RAID 管理/监控等能力。</li>\n<li>相比部署虚拟机系统，如 ESXi 或 proxmox ，由于 TrueNAS scale 已经支持了虚拟机和容器，我不需要再加一层套娃。</li>\n</ol>\n<p>RAID 方面，我的 4 块 4T 酷鹰组了 RAIDZ1(类似 RAID5)，实际容量在 10T 左右，确保在一块坏了的时候能够不丢失数据恢复。</p>\n<p>软件服务方面，我部署了以下的服务：</p>\n<ul>\n<li>qBittorrent：PT 下载。</li>\n<li>Homepage: 家庭服务仪表盘。</li>\n<li>icloudpd: 同步 iCloud 照片</li>\n<li>Jellyfin: 媒体服务器。</li>\n<li>TinyMediaManager: 影视元数据刮削。</li>\n<li>PhotoPrism: 照片管理</li>\n</ul>\n<h3>智能家居</h3>\n<p>作为 ios 用户，加上购买了 AppleTv 、HomePod 等一些设备，智能家居生态自然选择了 Apple 的 HomeKit 。主要设备有:</p>\n<ul>\n<li>网关: Aqara M1S/HomePod</li>\n<li>开关: Aqara D1</li>\n<li>空调控制: 郎宁 VRF</li>\n<li>窗帘电机: Aqara</li>\n<li>传感器: 小米人体传感器</li>\n<li>门锁: 小米智能门锁</li>\n<li>电视: AppleTv</li>\n</ul>\n<p>Aqara 设备通过网关直接接入 HomeKit ，小米设备则通过 HomeAssistant 桥接接入。</p>\n<h1>2024 年: 问题浮现与系统优化</h1>\n<h2>遇到的问题</h2>\n<p>2023 年的架构基本稳定运行至 2024 上半年，期间虽然偶尔出现 PT 流量误走代理、OpenClash 卡死等问题，但尚可接受。</p>\n<p>然而以上的拓扑存在一个致命的缺陷: <strong>弱电箱中的网管交换机成为单点故障</strong>。一旦损坏，替换过程极为繁琐，需重新配置 VLAN ，且端口顺序必须与原配置一致。</p>\n<p>而就在 2024 年的 5 月某天，那台网管交换机突然宕机了，我在重新下单等了 2 天收到货后开始配置，才发现完全不记得之前的 VLAN 设置了。当时正值 618 之际，在每天晚上下班仅有的 2 个小时内，花了 2 天才将家庭网络恢复如初。这促使我决心进行网络改造，重点是<strong>稳定性和容灾能力</strong></p>\n<h2>链路可用性分析</h2>\n<p>既然要增强系统稳定性及容灾能力，那么首先需要梳理一下目前的网络链路以及相关的可用性需求。</p>\n<table>\n<thead>\n<tr>\n<th>链路</th>\n<th>可用性需求</th>\n<th>达到可用时的最少设备</th>\n<th>达到可用时的最少系统组件</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>国内访问（部分设备）</td>\n<td>⭐⭐⭐⭐⭐</td>\n<td>路由器</td>\n<td>无</td>\n</tr>\n<tr>\n<td>无线连接</td>\n<td>⭐⭐⭐⭐</td>\n<td>路由器、AP</td>\n<td>无</td>\n</tr>\n<tr>\n<td>书房有线连接</td>\n<td>⭐⭐⭐⭐</td>\n<td>路由器、弱电箱到书房网线</td>\n<td>无</td>\n</tr>\n<tr>\n<td>客厅有线连接</td>\n<td>⭐⭐⭐⭐</td>\n<td>路由器、弱电箱到客厅网线</td>\n<td>无</td>\n</tr>\n<tr>\n<td>国际访问（部分设备）</td>\n<td>⭐⭐⭐</td>\n<td>路由器</td>\n<td>OpenClash</td>\n</tr>\n<tr>\n<td>PC 网络</td>\n<td>⭐⭐⭐</td>\n<td>路由器、PC</td>\n<td>无</td>\n</tr>\n<tr>\n<td>服务器网络</td>\n<td>⭐⭐</td>\n<td>路由器、服务器</td>\n<td>无</td>\n</tr>\n<tr>\n<td>智能家居可用</td>\n<td>⭐⭐</td>\n<td>路由器、交换机、智能家居网关</td>\n<td>HomeAssistant</td>\n</tr>\n<tr>\n<td>全设备国内访问</td>\n<td>⭐⭐</td>\n<td>路由器、交换机、AP</td>\n<td>无</td>\n</tr>\n<tr>\n<td>全设备国际访问</td>\n<td>⭐⭐</td>\n<td>软路由设备、交换机、AP</td>\n<td>OpenClash</td>\n</tr>\n<tr>\n<td>内网穿透</td>\n<td>⭐</td>\n<td>软路由设备</td>\n<td>阿里 DDNS 、域名服务</td>\n</tr>\n</tbody></table><p>其次，需要梳理一下网络中可能故障的节点以及其挂了后的影响面。对影响面的评估我分了以下几级：</p>\n<ul>\n<li>致命: 对网络可用性或完整性产生重大影响，且无法通过备用设备进行快恢。</li>\n<li>严重: 对网络可用性或完整性产生较大影响，但可以通过备用设备或降级部分功能完成核心功能恢复。</li>\n<li>一般: 对网络可用性或完整性产生影响，但有备用链路可以使用，或允许接受功能降级的情况。</li>\n<li>轻微: 有轻微体验影响的情况</li>\n</ul>\n<p>先列举一下物理设备可能的故障:</p>\n<table>\n<thead>\n<tr>\n<th>故障节点</th>\n<th>故障影响</th>\n<th>应急措施</th>\n<th>监测手段</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>书房至弱电箱网线故障</td>\n<td>致命</td>\n<td>书房的有线网络失效，需要额外引入书房 ap 连入客厅 ap 进行上网</td>\n<td>无有效手段</td>\n</tr>\n<tr>\n<td>客厅至弱电箱网线故障</td>\n<td>致命</td>\n<td>无线 ap 迁移至弱电箱内或书房，无线信号会受影响</td>\n<td>无有效手段</td>\n</tr>\n<tr>\n<td>软路由设备故障</td>\n<td>严重</td>\n<td>软路由设备临时替换为普通路由器拨号上网</td>\n<td>通过 ESXi 和 OpenWrt 探活可知，但实际确认需要线下</td>\n</tr>\n<tr>\n<td>弱电箱内交换机故障</td>\n<td>严重</td>\n<td>替换备用交换机</td>\n<td>无有效手段(原网管交换机有后台可以探活，但非网管的一般没有)</td>\n</tr>\n<tr>\n<td>书房交换机故障</td>\n<td>严重</td>\n<td>替换备用交换机</td>\n<td>无有效手段(同上)</td>\n</tr>\n<tr>\n<td>服务器设备故障</td>\n<td>严重</td>\n<td>无通用方案，根据故障情况处理</td>\n<td>软路由内部署脚本进行探活</td>\n</tr>\n<tr>\n<td>智能家居网关故障</td>\n<td>严重</td>\n<td>无应急方案</td>\n<td>HA 主动进行的设备探活</td>\n</tr>\n<tr>\n<td>无线 AP 故障</td>\n<td>严重</td>\n<td>替换备用 ap</td>\n<td>通过无线 ap 的端口探活</td>\n</tr>\n</tbody></table><p>然后是系统组件的可能的故障:</p>\n<table>\n<thead>\n<tr>\n<th>故障节点</th>\n<th>故障影响</th>\n<th>应急措施</th>\n<th>监测手段</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>ESXi 故障</td>\n<td>严重</td>\n<td>若重启无法失效需要替换为普通路由器拨号上网</td>\n<td>通过 ESXi 管理端口探活</td>\n</tr>\n<tr>\n<td>OpenWrt 故障</td>\n<td>严重</td>\n<td>exsi 内通过备份快照快速恢复即可</td>\n<td>通过 OpenWrt 管理端口探活</td>\n</tr>\n<tr>\n<td>TrueNAS 故障</td>\n<td>严重</td>\n<td>需要重装系统，管理配置通过备份恢复</td>\n<td>软路由内部署脚本进行探活</td>\n</tr>\n<tr>\n<td>OpenClash 故障</td>\n<td>一般</td>\n<td>重启或降级</td>\n<td>通过 OpenClash 端口探活</td>\n</tr>\n<tr>\n<td>HomeAssistant 故障</td>\n<td>一般</td>\n<td>exsi 内通过备份快照快速恢复即可</td>\n<td>通过 HA 端口探活</td>\n</tr>\n<tr>\n<td>DDNS 故障</td>\n<td>轻微</td>\n<td>重启/手动更新 IP</td>\n<td>无有效手段</td>\n</tr>\n</tbody></table><h2>物理拓扑的调整</h2>\n<p>根据上述的可用性优先级，我将物理拓扑图变成了这样:</p>\n<p><img alt=\"2024-网络拓扑\" class=\"embedded_image\" loading=\"lazy\" referrerpolicy=\"no-referrer\" rel=\"noreferrer\" src=\"https://i.imgur.com/IYo290f.png\"/></p>\n<p>从物理拓扑上来看，改变不算特别大，仅是将路由器从书房移回了弱电箱，但从稳定性的角度考虑，这一项调整让家庭减少了 2 个强依赖项，一个就是网管交换机，就算挂了我也可以替换为普通交换机，甚至不用交换机直连客厅 AP,也能保证局部的网络可用。另一个就是去除了弱电箱到书房的网线这个强依赖，一旦网线出问题，仅需降级书房的有线网络即可保障部分可用性。</p>\n<p>至于软路由的散热问题，一来在这一年的使用过程中，温度还算可控。二来我买了一个 usb 温控风扇贴着吹进行散热，整体评估放在弱电箱内问题不大。（是吗=。=）</p>\n<h2>系统架构的升级</h2>\n<p>在系统拓扑方面，改造的东西就相对较多一些了，在聊改造细节之前，我们还是先来看看当下遇到的问题有哪些：</p>\n<ol>\n<li>由于 OpenClash 的性能问题，导致间歇性的断网。</li>\n<li>当 OpenClash 的目标节点异常时没有主动感知，在连不上外网或者速度很慢时才能发现进行切换。</li>\n<li>PT 流量会经过代理服务器导致流量耗尽。</li>\n<li>所有数据共用一个磁盘组，PT 和重要数据的区分不够，有数据丢失风险，重要数据没有备份机制。</li>\n<li>网络的整体监控能力较弱，出现问题无法溯源。</li>\n<li>缺少各关键节点的容灾能力。</li>\n</ol>\n<p>为了解决以上的问题，系统的拓扑变成了这样：</p>\n<p><img alt=\"2024-网络拓扑\" class=\"embedded_image\" loading=\"lazy\" referrerpolicy=\"no-referrer\" rel=\"noreferrer\" src=\"https://i.imgur.com/bnxjsuU.png\"/></p>\n<h2>软路由内的调整</h2>\n<p>由上图所示，软路由内最大的一个改变，就是将 OpenClash 从拨号的 OpenWrt 内剥离了出去，并将拨号用的 OpenWrt 更改为了自编译的精简版本，插件只包含了阿里 ddns 和 mosdns ，其中阿里 ddns 用于内网穿透，而 mosdns 用做代理分流使用。</p>\n<p>首先需要说明一下这样调整后的网络请求顺序，为方便说明，拨号用的 OpenWrt 简称为 A ，OpenClash 所在的 OpenWrt 简称 B：</p>\n<p><img alt=\"\" class=\"embedded_image\" loading=\"lazy\" referrerpolicy=\"no-referrer\" rel=\"noreferrer\" src=\"https://i.imgur.com/EHPRHpb.png\"/></p>\n<p>如图所示，在这种网络链路下，国内请求不会经过 OpenClash ，同时为了控制 OpenClash 影响的 CPU 和内存范围，我选择在 ESXi 内单独起了一个虚拟机，用 ESXi 进行最大 CPU 和内存的限制，尽可能做到在 OpenClash 异常时不会耗尽整个路由器资源。至于为什么要再套一层 OpenWrt 而不是直接部署 OpenClash ，那是为了后续有其他插件需要安装时也可以从主链路中剥离开。</p>\n<p>而在 2024 年，为什么我还将 HomeAssistant 部署在软路由内，原因是当时高估了软路由的性能，并且因为担心服务器挂了可能会影响智能家居设备=.=</p>\n<h2>服务器的调整</h2>\n<p>首先提一下硬件上的调整(上图中没展示出来)，由于需要按资料重要性进行资源隔离，我新增了 2 块二手 12T 的氦气盘组了 RAID 1 阵列，高频读写的 PT 、影音等数据存在这个阵列内，原先的阵列用来存放家庭照片、数据备份、文档备份等。</p>\n<p>然后是服务器内部署的一些应用进行了调整:</p>\n<ul>\n<li>移除 Jellyfin：由于我没有在外看视频的需求，在家的话不需要在服务器上进行解码，直接传流手机解码即可，最终方案是在手机和电视上安装了 infuse 作为媒体观看软件。</li>\n<li>PhotoPrism 替换为 MTPhotos: PhotoPrism 属实难用。</li>\n<li>新增 Alist （网盘管理）、Calibre （电子书管理）。</li>\n<li>部署 Ubuntu 虚拟机: 用来部署相关的监控脚本。</li>\n<li>计划上会添加上 prometheus+grafana 作为监控套件，但实际 2024 年并未添加</li>\n</ul>\n<p>在增强稳定性方面，服务器上的脚本担任了绝大多数的任务需求，整个监控体系如下图所示:\n<img alt=\"\" class=\"embedded_image\" loading=\"lazy\" referrerpolicy=\"no-referrer\" rel=\"noreferrer\" src=\"https://i.imgur.com/t1CSCHN.png\"/></p>\n<p>其中的脚本都是非常简单的 shell 脚本，通过 http 请求对应服务的管理接口，有数据就当有心跳。这里可以看出当时的一个观点：只要不挂都不是大问题（笑）。但这套体系还是有不少的监控盲区和问题，最显而易见的，就是当 OpenWrt 或者 ESXi 挂了的时候，push 消息根本发不出来（这个问题居然一直到了 25 年才被反应过来）</p>\n<h1>2025 年: 体系化与稳定性建设</h1>\n<h2>发现问题</h2>\n<p>上述调整后的架构完美运行了很长时间，期间没有发生任何大问题，偶尔的 clash 异常也能在重启后恢复。但没出大问题也就意味着上述的降级容灾措施并没有被实际验证过。</p>\n<p>时间来到 2025 年的夏天，某个周末开始网络会时不时出现卡顿，一开始还以为是 PT 下载的缘故，由于持续时间不长就没太关注。但慢慢的卡顿频率越来越多，有时候 OpenWrt 的 CPU 占用会飙升到 100%，排查发现 OpenWrt 内 CPU 占用最高的线程是 ksoftirqd ，ksoftirqd 是一个处理软中断的线程，它占 CPU 高往往是结果而不是原因。深入排查发现在弱电箱内的软路由在正常情况下就烫的厉害，那会不会是因为软路由散热不好导致 CPU 降频或网卡异常进而触发了软中断爆炸呢，在换了一个更大的散热风扇后，这个情况再没有发生。</p>\n<p>这个事件让我看到了 2 个问题：</p>\n<ol>\n<li>现有监控无法捕捉瞬时异常，缺乏历史数据追踪。</li>\n<li>软路由的负载过高，需进一步划清设备职责。</li>\n</ol>\n<p>这样下来，2025 年的改造目标，重点就是：</p>\n<p><strong>建设体系化监控+设备能力单一化</strong></p>\n<h2>监控体系升级</h2>\n<p>其实在 2024 年的规划中，就已经画出了 grafana+prometheus 的套件组合，但由于 prometheus 过于原始的配置方式，加上当时认为脚本探活就可以完成家庭网络的监控工作，这 2 者并没有被使用起来。</p>\n<p>回到现在，监控体系还是选择使用 grafana+prometheus 的组合，毕竟开源解决方案很多。安装后的效果如下。</p>\n<p><img alt=\"\" class=\"embedded_image\" loading=\"lazy\" referrerpolicy=\"no-referrer\" rel=\"noreferrer\" src=\"https://i.imgur.com/8znNMf2.png\"/></p>\n<p>关于 prometheus exporter 的选择，目前是这样的:</p>\n<table>\n<thead>\n<tr>\n<th>监控节点</th>\n<th>拉取速度</th>\n<th>核心关注指标</th>\n<th>exporter 来源</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>OpenWrt</td>\n<td>5s</td>\n<td>CPU 使用率、内存使用率、load 、网络 io 、活跃连接数</td>\n<td>OpenWrt 软件包内自带</td>\n</tr>\n<tr>\n<td>HomeAssistant</td>\n<td>30s</td>\n<td>设备电池电量、空调使用时间</td>\n<td>HA 插件</td>\n</tr>\n<tr>\n<td>TrueNAS</td>\n<td>5s</td>\n<td>CPU 使用率、内存使用率、load 、磁盘 io 、网络 io</td>\n<td><a href=\"https://github.com/Supporterino/TrueNAS-graphite-to-prometheus\" rel=\"nofollow\">https://github.com/Supporterino/TrueNAS-graphite-to-prometheus</a></td>\n</tr>\n<tr>\n<td>qBittorrent</td>\n<td>60s</td>\n<td>下载/上传速度、做种数</td>\n<td>自建</td>\n</tr>\n<tr>\n<td>OpenClash</td>\n<td>20s</td>\n<td>下载/上传速度、流量使用量、活跃连接数、国内/国际 ping 延时</td>\n<td>自建</td>\n</tr>\n</tbody></table><p>需要提的是为什么没有 ESXi 的 exporter ，原因是不想为了监控再装一个 vCenter 了=。=</p>\n<h2>日志</h2>\n<blockquote>\n<p>日志及下述单一化的部分在这篇文章写作之时并没有完全调整完成，这里主要说一下我的方案。</p>\n</blockquote>\n<p>既然监控使用了 grafana ，日志当然使用 promtail+loki 的配套搭配，但看了文档发现 promtail 目前已经被弃用了，替代者是 alloy ，所以整个的日志方案就变成了 alloy(日志采集)+loki(日志存储)+grafana(日志看板)的组合拳。</p>\n<p>TrueNAS 内的日志采集直接部署 alloy 应用即可，日志基本集中在/var/log 目录下，我目前是采集了/var/log/containers/*和/var/log/syslog.log 用以监控应用和系统的关键日志。</p>\n<p>OpenWrt 的日志采集，我决定参考 <a href=\"https://github.com/defanator/openwrt-loki-exporter?tab=readme-ov-file\" rel=\"nofollow\">github</a> 的方案在 OpenWrt 内直接部署日志上报的功能。</p>\n<p>ESXi 和 HomeAssistant 暂不接入。</p>\n<h2>设备职责单一化</h2>\n<p>在软件工程里，KISS 原则是一个非常重要的工程实践方法。回看前两年迭代的结构演进，有哪些地方违法了 KISS 原则呢？</p>\n<ol>\n<li>为了减少 OpenClash 对系统的影响，引入了 mosdns 进入主链路。</li>\n<li>软路由内部署了 HomeAssistant 。</li>\n<li>存储服务器承担了越来越多的计算工作。</li>\n</ol>\n<p>要如何解决这 3 个问题呢，我目前的方案如下：</p>\n<p>关于问题 1, 当我在 2025 年再次审视 clash 的配置时，发现其实 clash 本身就支持 dns 分流及按配置绕过内核，引入 mosdns 似乎并不需要，于是我将 2 个 OpenWrt 再次删减为一个，仅使用 OpenClash 的规则配置进行流量分流，这个方案带来的唯一问题可能 CPU 会被 clash 吃满，但这通过监控也可以完成 clash 自动启停。关于 clash 的配置，github 上的<a href=\"https://github.com/Aethersailor/Custom_OpenClash_Rules\" rel=\"nofollow\">这个仓库</a>有非常详尽的教学，可以参考。</p>\n<p>关于问题 2, 很好解决，我将 HomeAssistant 从软路由迁移至服务器。</p>\n<p>关于问题 3 ，这实际是个成本问题（哈哈）。随着监控和日志系统的完善，我计划观察一段时间服务器使用，如果确实日常计算量很高，可能会考虑增加一台专用计算的设备保障存储设备的稳定性。（比如 mac mini ）</p>\n<h1>最后</h1>\n<p>家庭网络的建设是一个持续迭代的过程，从最初的“能用到”到“稳定用”，再到“高效与可观测”，每一个阶段都伴随着新的挑战与解决方案。本文重点分享了设计思路与架构演进，具体技术细节将在后续文章展开。如果你也正在构建家庭网络，希望本文能为你提供一些参考。</p>\n", "last_modified": 1758087894, "replies": 69, "id": 1159920}, {"node": {"avatar_large": "https://cdn.v2ex.com/navatar/6e27/13a6/557_large.png?m=1747623425", "name": "life", "avatar_normal": "https://cdn.v2ex.com/navatar/6e27/13a6/557_normal.png?m=1747623425", "title": "生活", "url": "https://www.v2ex.com/go/life", "topics": 8810, "footer": "", "header": "生活中的技术讨论", "title_alternative": "Life", "avatar_mini": "https://cdn.v2ex.com/navatar/6e27/13a6/557_mini.png?m=1747623425", "stars": 1971, "aliases": [], "root": false, "id": 557, "parent_node_name": ""}, "member": {"id": 651554, "username": "hiLuck", "url": "https://www.v2ex.com/u/hiLuck", "website": null, "twitter": null, "psn": null, "github": null, "btc": null, "location": null, "tagline": null, "bio": null, "avatar_mini": "https://cdn.v2ex.com/gravatar/bda95ac878c1e609bd0ce995cfa76130?s=24&d=retro", "avatar_normal": "https://cdn.v2ex.com/gravatar/bda95ac878c1e609bd0ce995cfa76130?s=48&d=retro", "avatar_large": "https://cdn.v2ex.com/gravatar/bda95ac878c1e609bd0ce995cfa76130?s=73&d=retro", "created": 1695864230, "last_modified": 1695864230, "pro": 0}, "last_reply_by": "li1uo", "last_touched": 1758167990, "title": "相亲遇到的一些问题，希望大家指点迷津", "url": "https://www.v2ex.com/t/1160089", "created": 1758159741, "deleted": 0, "content": "相亲认识的女生，因为家里都是单亲，所以想着可能某些方面会感同身受，就一直相处下来了。但是目前相处下来感觉好累，老哥们帮忙出出意见。\r\n目前一共接触四个多月了，确认关系一个多月。刚认识的时候，和女生聊天就各种暗示饿了、累了啥的，我想这也就花点小钱点点外卖也就算了。期间出去约会吃饭、奶茶、电影都是我出，女生只买过两次奶茶，并且见面邀约都是我提起的，如果我没有约见，这个星期可能就不会见面了。我认为感情里付出都是相互的，女生生日我送了手链，女生回赠了价值一半的礼物，这后面我的付出就没看到回馈了。确认关系送了一千多的化妆品，七夕节发了 520 红包。确认关系后，女生聊天的时候经常说闺蜜男朋友给她闺蜜在节日里会买礼物、首饰之类的话，还发一些金首饰、包包照片说好看，很喜欢，我能看出这是暗示我花钱了，但是我感觉这些都是需要感情基础才会赠送的礼物。\r\n因此这些问题我们发生过矛盾，我说感情应该是双向付出的，目前的相处让我感觉像是单向追求。女生回应说同意双向付出，但需要我告诉她应该怎么付出。另一个问题是发昂贵金首饰和包包照片，我说我的家庭可能不能支持这么贵的礼物，女生说只是分享下自己喜欢的东西，说我太敏感了？\r\n自己是单亲家庭，家里剩余的继续勉强支持结婚和买房，感觉和女生消费观不大一致，女生的爱好是穿搭和化妆，平时穿戴首饰也很多。目前选择推出会感觉如释重负，但也会有点可惜，恋爱经验不是很丰富，也不是很愿意做舔狗，老哥们能否指点下迷津。", "content_rendered": "<p>相亲认识的女生，因为家里都是单亲，所以想着可能某些方面会感同身受，就一直相处下来了。但是目前相处下来感觉好累，老哥们帮忙出出意见。\n目前一共接触四个多月了，确认关系一个多月。刚认识的时候，和女生聊天就各种暗示饿了、累了啥的，我想这也就花点小钱点点外卖也就算了。期间出去约会吃饭、奶茶、电影都是我出，女生只买过两次奶茶，并且见面邀约都是我提起的，如果我没有约见，这个星期可能就不会见面了。我认为感情里付出都是相互的，女生生日我送了手链，女生回赠了价值一半的礼物，这后面我的付出就没看到回馈了。确认关系送了一千多的化妆品，七夕节发了 520 红包。确认关系后，女生聊天的时候经常说闺蜜男朋友给她闺蜜在节日里会买礼物、首饰之类的话，还发一些金首饰、包包照片说好看，很喜欢，我能看出这是暗示我花钱了，但是我感觉这些都是需要感情基础才会赠送的礼物。\n因此这些问题我们发生过矛盾，我说感情应该是双向付出的，目前的相处让我感觉像是单向追求。女生回应说同意双向付出，但需要我告诉她应该怎么付出。另一个问题是发昂贵金首饰和包包照片，我说我的家庭可能不能支持这么贵的礼物，女生说只是分享下自己喜欢的东西，说我太敏感了？\n自己是单亲家庭，家里剩余的继续勉强支持结婚和买房，感觉和女生消费观不大一致，女生的爱好是穿搭和化妆，平时穿戴首饰也很多。目前选择推出会感觉如释重负，但也会有点可惜，恋爱经验不是很丰富，也不是很愿意做舔狗，老哥们能否指点下迷津。</p>\n", "last_modified": 1758159741, "replies": 67, "id": 1160089}, {"node": {"avatar_large": "https://cdn.v2ex.com/navatar/3b5d/ca50/819_large.png?m=1633251402", "name": "watch", "avatar_normal": "https://cdn.v2ex.com/navatar/3b5d/ca50/819_normal.png?m=1633251402", "title": " WATCH", "url": "https://www.v2ex.com/go/watch", "topics": 1410, "footer": "", "header": "<a href=\"/go/apple\">Apple</a> 公司设计的智能手表产品", "title_alternative": " WATCH", "avatar_mini": "https://cdn.v2ex.com/navatar/3b5d/ca50/819_mini.png?m=1633251402", "stars": 578, "aliases": [], "root": false, "id": 819, "parent_node_name": "apple"}, "member": {"id": 383508, "username": "MarchPig", "url": "https://www.v2ex.com/u/MarchPig", "website": "", "twitter": null, "psn": null, "github": null, "btc": null, "location": "", "tagline": "", "bio": "", "avatar_mini": "https://cdn.v2ex.com/avatar/7164/e6f1/383508_mini.png?m=1745045536", "avatar_normal": "https://cdn.v2ex.com/avatar/7164/e6f1/383508_normal.png?m=1745045536", "avatar_large": "https://cdn.v2ex.com/avatar/7164/e6f1/383508_large.png?m=1745045536", "avatar_xlarge": "https://cdn.v2ex.com/avatar/7164/e6f1/383508_xlarge.png?m=1745045536", "avatar_xxlarge": "https://cdn.v2ex.com/avatar/7164/e6f1/383508_xxlarge.png?m=1745045536", "avatar_xxxlarge": "https://cdn.v2ex.com/avatar/7164/e6f1/383508_xxxlarge.png?m=1745045536", "created": 1550043978, "last_modified": 1745045536, "pro": 0}, "last_reply_by": "s1461a", "last_touched": 1758168368, "title": "国行 Watch 开通房颤和睡眠呼吸暂停", "url": "https://www.v2ex.com/t/1159981", "created": 1758097900, "deleted": 0, "content": "偶然间看到信息，发现原来国行的几个功能是没开通的，查了信息发现，如果要开通，\r\n1 、要么是尾插+魔法，\r\n2 、要么是肉身带设备能接入 HK 信号，\r\n3 、要么是登录别人 ID 或者把自己 ID 给别人帮忙开通\r\n\r\n经过实践，结果使用某款 xxxgo 软件（ xxx 等于名称不是真的 xxx ，我不知道是否违规，所以用 xxx 代替了），配合魔法，全软环境成功开通。\r\n我的环境，iphone 15 Pro +ios26+apple watch s10+watchOS 26+魔法全局 HK,macOS 安装 xxxgo ，全程没有更换 ID 什么的。\r\n1 、全程关闭了 apple watch ；根据提示关闭定位服务；\r\n2 、使用 xxxgo 蓝牙模式连接 iphone ，根据提示该关闭关闭，该打开打开。\r\n3 、手机上全局魔法 HK ，用百度地图或者高德验证定位是否完成修改；\r\n4 、注意看 xxxgo 软件的提示，可能需要在手机上安装辅助软件，我开通第二个功能的时候用到了辅助；\r\n5 、最后房颤历史开不了，是因为和 ECG App 只能二选一。\r\n在全部恢复到正常环境后，“房颤历史”的提示从二选一变成了所在地区不可用。\r\n\r\n最后，信息差是存在的，万能某宝有付费，不想麻烦的可以万能宝，注意 ID 安全即可。", "content_rendered": "偶然间看到信息，发现原来国行的几个功能是没开通的，查了信息发现，如果要开通，<br />1 、要么是尾插+魔法，<br />2 、要么是肉身带设备能接入 HK 信号，<br />3 、要么是登录别人 ID 或者把自己 ID 给别人帮忙开通<br /><br />经过实践，结果使用某款 xxxgo 软件（ xxx 等于名称不是真的 xxx ，我不知道是否违规，所以用 xxx 代替了），配合魔法，全软环境成功开通。<br />我的环境，iphone 15 Pro +ios26+apple watch s10+watchOS 26+魔法全局 HK,macOS 安装 xxxgo ，全程没有更换 ID 什么的。<br />1 、全程关闭了 apple watch ；根据提示关闭定位服务；<br />2 、使用 xxxgo 蓝牙模式连接 iphone ，根据提示该关闭关闭，该打开打开。<br />3 、手机上全局魔法 HK ，用百度地图或者高德验证定位是否完成修改；<br />4 、注意看 xxxgo 软件的提示，可能需要在手机上安装辅助软件，我开通第二个功能的时候用到了辅助；<br />5 、最后房颤历史开不了，是因为和 ECG App 只能二选一。<br />在全部恢复到正常环境后，“房颤历史”的提示从二选一变成了所在地区不可用。<br /><br />最后，信息差是存在的，万能某宝有付费，不想麻烦的可以万能宝，注意 ID 安全即可。", "last_modified": 1758098247, "replies": 64, "id": 1159981}, {"node": {"avatar_large": "https://cdn.v2ex.com/navatar/301a/d0e3/834_large.png?m=1584400459", "name": "xiaomi", "avatar_normal": "https://cdn.v2ex.com/navatar/301a/d0e3/834_normal.png?m=1584400459", "title": "小米", "url": "https://www.v2ex.com/go/xiaomi", "topics": 1225, "footer": "", "header": "关于小米公司出品的各种智能硬件的使用讨论", "title_alternative": "Xiaomi", "avatar_mini": "https://cdn.v2ex.com/navatar/301a/d0e3/834_mini.png?m=1584400459", "stars": 465, "aliases": [], "root": false, "id": 834, "parent_node_name": "android"}, "member": {"id": 569659, "username": "0x93ee", "url": "https://www.v2ex.com/u/0x93ee", "website": null, "twitter": null, "psn": null, "github": null, "btc": null, "location": null, "tagline": null, "bio": null, "avatar_mini": "https://cdn.v2ex.com/avatar/e90c/f02a/569659_mini.png?m=1757585266", "avatar_normal": "https://cdn.v2ex.com/avatar/e90c/f02a/569659_normal.png?m=1757585266", "avatar_large": "https://cdn.v2ex.com/avatar/e90c/f02a/569659_large.png?m=1757585266", "avatar_xlarge": "https://cdn.v2ex.com/avatar/e90c/f02a/569659_xlarge.png?m=1757585266", "avatar_xxlarge": "https://cdn.v2ex.com/avatar/e90c/f02a/569659_xxlarge.png?m=1757585266", "created": 1642667088, "last_modified": 1757585266, "pro": 0}, "last_reply_by": "bluearc", "last_touched": 1758166737, "title": "小米这改名 17 真的是 low 到家了", "url": "https://www.v2ex.com/t/1159975", "created": 1758096230, "deleted": 0, "content": "之前买个小米觉得只会被黑是“系统垃圾”，只会搞营销。\r\n\r\n这改名 17 后，这不自己给自己贴了个“买不起苹果 17 的穷屌丝只能买小米 17 了”。搞得想买小米 17 的也不好意思买了。\r\n\r\n我家里一堆米家设备，这下看来主力机要换其他品牌了。\r\n\r\n不知道是哪个蠢材给小米出的“好主意”。", "content_rendered": "<p>之前买个小米觉得只会被黑是“系统垃圾”，只会搞营销。</p>\n<p>这改名 17 后，这不自己给自己贴了个“买不起苹果 17 的穷屌丝只能买小米 17 了”。搞得想买小米 17 的也不好意思买了。</p>\n<p>我家里一堆米家设备，这下看来主力机要换其他品牌了。</p>\n<p>不知道是哪个蠢材给小米出的“好主意”。</p>\n", "last_modified": 1758096230, "replies": 63, "id": 1159975}, {"node": {"avatar_large": "https://cdn.v2ex.com/navatar/6cdd/60ea/184_large.png?m=1630643913", "name": "apple", "avatar_normal": "https://cdn.v2ex.com/navatar/6cdd/60ea/184_normal.png?m=1630643913", "title": "Apple", "url": "https://www.v2ex.com/go/apple", "topics": 29401, "footer": "", "header": "设计了 <a href=\"/go/watch\">Apple Watch</a>，<a href=\"/go/ipad\">iPad</a>，<a href=\"/go/iphone\">iPhone</a>，<a href=\"/go/imac\">iMac</a> 及 <a href=\"/go/mbp\">MacBook Pro</a> 等电子产品的美国公司。", "title_alternative": "Apple", "avatar_mini": "https://cdn.v2ex.com/navatar/6cdd/60ea/184_mini.png?m=1630643913", "stars": 3219, "aliases": [], "root": false, "id": 184, "parent_node_name": "hardware"}, "member": {"id": 570284, "username": "mariljacksoa", "url": "https://www.v2ex.com/u/mariljacksoa", "website": null, "twitter": null, "psn": null, "github": null, "btc": null, "location": null, "tagline": null, "bio": null, "avatar_mini": "https://cdn.v2ex.com/gravatar/0e34b31c32948d8bcd83867f5585e0b9?s=24&d=retro", "avatar_normal": "https://cdn.v2ex.com/gravatar/0e34b31c32948d8bcd83867f5585e0b9?s=48&d=retro", "avatar_large": "https://cdn.v2ex.com/gravatar/0e34b31c32948d8bcd83867f5585e0b9?s=73&d=retro", "created": 1643200905, "last_modified": 1645259635, "pro": 0}, "last_reply_by": "Crazy07", "last_touched": 1758168258, "title": "iPhone14pro Max 有必要换 iPhone17 吗？", "url": "https://www.v2ex.com/t/1160081", "created": 1758158518, "deleted": 0, "content": "14pm 刚发布时花了 9000 多买的，用了三年，电池健康度低于 80%了，纠结的点：\n1.如果 14pm 换电池的话体验如何？官方换电池也不便宜，大概 800¥。之前用的 iPhone8plus 换过电池，续航还是一般，在授权服务商换的，不知道和直营店换的有没有区别。换过电池的朋友可以分享一下使用体验。\n2.17 只考虑基础版，感觉普通人用基础版足够了，pro 也不是买不起，只不过觉得花差不多一万块买一部手机不是很有必要。因为用过 14pm 之后喜欢大屏，17 有 plus 的话就不纠结了，直接换。\n3.14pm 目前的回收价大概是 3000 元，手机用了三年，就这样回收了感觉还没发挥它最大的价值。", "content_rendered": "14pm 刚发布时花了 9000 多买的，用了三年，电池健康度低于 80%了，纠结的点：<br />1.如果 14pm 换电池的话体验如何？官方换电池也不便宜，大概 800¥。之前用的 iPhone8plus 换过电池，续航还是一般，在授权服务商换的，不知道和直营店换的有没有区别。换过电池的朋友可以分享一下使用体验。<br />2.17 只考虑基础版，感觉普通人用基础版足够了，pro 也不是买不起，只不过觉得花差不多一万块买一部手机不是很有必要。因为用过 14pm 之后喜欢大屏，17 有 plus 的话就不纠结了，直接换。<br />3.14pm 目前的回收价大概是 3000 元，手机用了三年，就这样回收了感觉还没发挥它最大的价值。", "last_modified": 1758158518, "replies": 56, "id": 1160081}]