[{"node": {"avatar_large": "https://cdn.v2ex.com/navatar/301a/d0e3/834_large.png?m=1584400459", "name": "xiaomi", "avatar_normal": "https://cdn.v2ex.com/navatar/301a/d0e3/834_normal.png?m=1584400459", "title": "小米", "url": "https://www.v2ex.com/go/xiaomi", "topics": 1272, "footer": "", "header": "关于小米公司出品的各种智能硬件的使用讨论", "title_alternative": "Xiaomi", "avatar_mini": "https://cdn.v2ex.com/navatar/301a/d0e3/834_mini.png?m=1584400459", "stars": 482, "aliases": [], "root": false, "id": 834, "parent_node_name": "android"}, "member": {"id": 589328, "username": "ccctttwww", "url": "https://www.v2ex.com/u/ccctttwww", "website": null, "twitter": null, "psn": null, "github": null, "btc": null, "location": null, "tagline": null, "bio": null, "avatar_mini": "https://cdn.v2ex.com/avatar/91d8/6992/589328_mini.png?m=1759124730", "avatar_normal": "https://cdn.v2ex.com/avatar/91d8/6992/589328_normal.png?m=1759124730", "avatar_large": "https://cdn.v2ex.com/avatar/91d8/6992/589328_large.png?m=1759124730", "avatar_xlarge": "https://cdn.v2ex.com/avatar/91d8/6992/589328_xlarge.png?m=1759124730", "avatar_xxlarge": "https://cdn.v2ex.com/avatar/91d8/6992/589328_xxlarge.png?m=1759124730", "avatar_xxxlarge": "https://cdn.v2ex.com/avatar/91d8/6992/589328_xxxlarge.png?m=1759124730", "created": 1658994387, "last_modified": 1759124730, "pro": 0}, "last_reply_by": "elviscai", "last_touched": 1761927453, "title": "都说小米这么差，难道没买过好用的吗，说说你买过好用的小米产品有哪些", "url": "https://www.v2ex.com/t/1169725", "created": 1761895538, "deleted": 0, "content": "我买了大大小小几十个小米了，最近准备家里全套米家设备，也是比较喜欢小米的设计风格，能不能说下小米哪些产品用的很不错，我就不信小米的全都这么垃圾", "content_rendered": "<p>我买了大大小小几十个小米了，最近准备家里全套米家设备，也是比较喜欢小米的设计风格，能不能说下小米哪些产品用的很不错，我就不信小米的全都这么垃圾</p>\n", "last_modified": 1761895538, "replies": 94, "id": 1169725}, {"node": {"avatar_large": "https://cdn.v2ex.com/navatar/6e27/13a6/557_large.png?m=1747623425", "name": "life", "avatar_normal": "https://cdn.v2ex.com/navatar/6e27/13a6/557_normal.png?m=1747623425", "title": "生活", "url": "https://www.v2ex.com/go/life", "topics": 9162, "footer": "", "header": "生活中的技术讨论", "title_alternative": "Life", "avatar_mini": "https://cdn.v2ex.com/navatar/6e27/13a6/557_mini.png?m=1747623425", "stars": 2023, "aliases": [], "root": false, "id": 557, "parent_node_name": ""}, "member": {"id": 492998, "username": "xiaoyanger", "url": "https://www.v2ex.com/u/xiaoyanger", "website": null, "twitter": null, "psn": null, "github": null, "btc": null, "location": null, "tagline": null, "bio": null, "avatar_mini": "https://cdn.v2ex.com/gravatar/fb87f1cd10cb5f1de516bfb174d5cf64?s=24&d=retro", "avatar_normal": "https://cdn.v2ex.com/gravatar/fb87f1cd10cb5f1de516bfb174d5cf64?s=48&d=retro", "avatar_large": "https://cdn.v2ex.com/gravatar/fb87f1cd10cb5f1de516bfb174d5cf64?s=73&d=retro", "created": 1591180474, "last_modified": 1757382887, "pro": 0}, "last_reply_by": "michaelso", "last_touched": 1761945180, "title": "第一次发贴，祝我生日快乐吧", "url": "https://www.v2ex.com/t/1169734", "created": 1761897946, "deleted": 0, "content": "第一次发帖，祝自己生日快乐吧，家人和朋友没有一个记得自己的生日，无聊的一天...", "content_rendered": "<p>第一次发帖，祝自己生日快乐吧，家人和朋友没有一个记得自己的生日，无聊的一天...</p>\n", "last_modified": 1761897946, "replies": 58, "id": 1169734}, {"node": {"avatar_large": "https://cdn.v2ex.com/navatar/df0a/ab05/1148_large.png?m=1751736790", "name": "claude", "avatar_normal": "https://cdn.v2ex.com/navatar/df0a/ab05/1148_normal.png?m=1751736790", "title": "Claude", "url": "https://www.v2ex.com/go/claude", "topics": 194, "footer": "", "header": "", "title_alternative": "Claude", "avatar_mini": "https://cdn.v2ex.com/navatar/df0a/ab05/1148_mini.png?m=1751736790", "stars": 168, "aliases": [], "root": false, "id": 1148, "parent_node_name": "geek"}, "member": {"id": 400140, "username": "klykq111", "url": "https://www.v2ex.com/u/klykq111", "website": null, "twitter": null, "psn": null, "github": null, "btc": null, "location": null, "tagline": null, "bio": null, "avatar_mini": "https://cdn.v2ex.com/gravatar/d79bd59412bf7444c339476e2161d085?s=24&d=retro", "avatar_normal": "https://cdn.v2ex.com/gravatar/d79bd59412bf7444c339476e2161d085?s=48&d=retro", "avatar_large": "https://cdn.v2ex.com/gravatar/d79bd59412bf7444c339476e2161d085?s=73&d=retro", "created": 1554856563, "last_modified": 1554856563, "pro": 0}, "last_reply_by": "airqj", "last_touched": 1761980458, "title": "V 友们专属 🎉 cc && codex 抽 月卡！ 10 张~", "url": "https://www.v2ex.com/t/1169752", "created": 1761900858, "deleted": 0, "content": "bast64 : aHR0cHM6Ly9jbGF1ZGVjb2RlOC5jb20=\r\n\r\n小月卡 大概 5.7×10⁹ token \r\n\r\n\t[奖品 1]： 小月卡 × 10 张\r\n    [奖品 2]： 新用户 3k 积分 1 约等于 3.8 约等于 114M token \r\n    \r\n参与方式\r\n\r\n跟帖 UID\r\n\r\n帖在 活动在 \r\n帖不在 我能看到 活动在\r\n帖不在 group 发密语 \"vv\" 活动在\r\n帖不在 发 v 友回复截图/争取 活动子啊  \r\n\r\n双重福利 \r\n\r\n新用户 注册 3000 , group 发密语 v +2000 （对看完的 v 友福利)\r\n\r\n确保稳定 不玩虚的", "content_rendered": "<p>bast64 : aHR0cHM6Ly9jbGF1ZGVjb2RlOC5jb20=</p>\n<p>小月卡 大概 5.7×10⁹ token </p>\n<pre><code>[奖品 1]： 小月卡 × 10 张\n[奖品 2]： 新用户 3k 积分 1 约等于 3.8 约等于 114M token \n</code></pre>\n<p>参与方式</p>\n<p>跟帖 UID</p>\n<p>帖在 活动在\n帖不在 我能看到 活动在\n帖不在 group 发密语 \"vv\" 活动在\n帖不在 发 v 友回复截图/争取 活动子啊  </p>\n<p>双重福利 </p>\n<p>新用户 注册 3000 , group 发密语 v +2000 （对看完的 v 友福利)</p>\n<p>确保稳定 不玩虚的</p>\n", "last_modified": 1761965926, "replies": 36, "id": 1169752}, {"node": {"avatar_large": "https://cdn.v2ex.com/navatar/c20a/d4d7/12_large.png?m=1751718333", "name": "qna", "avatar_normal": "https://cdn.v2ex.com/navatar/c20a/d4d7/12_normal.png?m=1751718333", "title": "问与答", "url": "https://www.v2ex.com/go/qna", "topics": 234738, "footer": "", "header": "<!--\r\n一个更好的世界需要你持续地提出好问题。\r\n-->", "title_alternative": "Questions and Answers", "avatar_mini": "https://cdn.v2ex.com/navatar/c20a/d4d7/12_mini.png?m=1751718333", "stars": 4420, "aliases": [], "root": false, "id": 12, "parent_node_name": "v2ex"}, "member": {"id": 714648, "username": "tiancaiXD", "url": "https://www.v2ex.com/u/tiancaiXD", "website": "", "twitter": null, "psn": null, "github": null, "btc": null, "location": "", "tagline": "", "bio": "", "avatar_mini": "https://cdn.v2ex.com/avatar/7f32/d4c7/714648_mini.png?m=1754102777", "avatar_normal": "https://cdn.v2ex.com/avatar/7f32/d4c7/714648_normal.png?m=1754102777", "avatar_large": "https://cdn.v2ex.com/avatar/7f32/d4c7/714648_large.png?m=1754102777", "avatar_xlarge": "https://cdn.v2ex.com/avatar/7f32/d4c7/714648_xlarge.png?m=1754102777", "avatar_xxlarge": "https://cdn.v2ex.com/avatar/7f32/d4c7/714648_xxlarge.png?m=1754102777", "created": 1728788067, "last_modified": 1754102777, "pro": 1761979814}, "last_reply_by": "simo", "last_touched": 1761980700, "title": "身体出现明显衰老的信号", "url": "https://www.v2ex.com/t/1169856", "created": 1761968463, "deleted": 0, "content": "1 、半夜需要起床上厕所越来越频繁，没办法一觉睡到自然醒，总会被尿憋醒\r\n\r\n2 、晨勃次数变少，概率低于 2 分之 1\r\n\r\n还有哪些身体变老的信号，各位也分享下", "content_rendered": "<p>1 、半夜需要起床上厕所越来越频繁，没办法一觉睡到自然醒，总会被尿憋醒</p>\n<p>2 、晨勃次数变少，概率低于 2 分之 1</p>\n<p>还有哪些身体变老的信号，各位也分享下</p>\n", "last_modified": 1761968463, "replies": 31, "id": 1169856}, {"node": {"avatar_large": "https://cdn.v2ex.com/navatar/e44f/ea3b/454_large.png?m=1657260508", "name": "lol", "avatar_normal": "https://cdn.v2ex.com/navatar/e44f/ea3b/454_normal.png?m=1657260508", "title": "英雄联盟", "url": "https://www.v2ex.com/go/lol", "topics": 381, "footer": "", "header": "League of Legends (LoL) is a multiplayer online battle arena video game.", "title_alternative": "League of Legends", "avatar_mini": "https://cdn.v2ex.com/navatar/e44f/ea3b/454_mini.png?m=1657260508", "stars": 474, "aliases": [], "root": false, "id": 454, "parent_node_name": "games"}, "member": {"id": 289692, "username": "lnexin", "url": "https://www.v2ex.com/u/lnexin", "website": null, "twitter": null, "psn": null, "github": null, "btc": null, "location": null, "tagline": null, "bio": null, "avatar_mini": "https://cdn.v2ex.com/gravatar/47d4e43b29086b98a652c16a397f9529?s=24&d=retro", "avatar_normal": "https://cdn.v2ex.com/gravatar/47d4e43b29086b98a652c16a397f9529?s=48&d=retro", "avatar_large": "https://cdn.v2ex.com/gravatar/47d4e43b29086b98a652c16a397f9529?s=73&d=retro", "created": 1517812624, "last_modified": 1517812624, "pro": 0}, "last_reply_by": "genewzxk666", "last_touched": 1761911776, "title": "下午 AL 能赢 T1 吗", "url": "https://www.v2ex.com/t/1169720", "created": 1761894925, "deleted": 0, "content": "有点想看，但又怕看了怄气,哎", "content_rendered": "<p>有点想看，但又怕看了怄气,哎</p>\n", "last_modified": 1761894925, "replies": 30, "id": 1169720}, {"node": {"avatar_large": "https://cdn.v2ex.com/navatar/c20a/d4d7/12_large.png?m=1751718333", "name": "qna", "avatar_normal": "https://cdn.v2ex.com/navatar/c20a/d4d7/12_normal.png?m=1751718333", "title": "问与答", "url": "https://www.v2ex.com/go/qna", "topics": 234738, "footer": "", "header": "<!--\r\n一个更好的世界需要你持续地提出好问题。\r\n-->", "title_alternative": "Questions and Answers", "avatar_mini": "https://cdn.v2ex.com/navatar/c20a/d4d7/12_mini.png?m=1751718333", "stars": 4420, "aliases": [], "root": false, "id": 12, "parent_node_name": "v2ex"}, "member": {"id": 239594, "username": "jacketma", "url": "https://www.v2ex.com/u/jacketma", "website": null, "twitter": null, "psn": null, "github": null, "btc": null, "location": null, "tagline": null, "bio": null, "avatar_mini": "https://cdn.v2ex.com/gravatar/a941f83ac4192740c2e1f95676ce23c5?s=24&d=retro", "avatar_normal": "https://cdn.v2ex.com/gravatar/a941f83ac4192740c2e1f95676ce23c5?s=48&d=retro", "avatar_large": "https://cdn.v2ex.com/gravatar/a941f83ac4192740c2e1f95676ce23c5?s=73&d=retro", "created": 1499704166, "last_modified": 1746073077, "pro": 0}, "last_reply_by": "shenyiyouge", "last_touched": 1761980060, "title": "抖音不小心点赞了视频，立即取消点赞。up 主会知道谁赞了这个视频吗？", "url": "https://www.v2ex.com/t/1169833", "created": 1761960622, "deleted": 0, "content": "在抖音上点赞了别人的视频，经常收到别人的感谢信息。\r\n\r\nup 主应该都能看到是谁点赞了视频吧，点赞后，立即取消点赞。up 主还会知道谁赞了这个视频吗？", "content_rendered": "<p>在抖音上点赞了别人的视频，经常收到别人的感谢信息。</p>\n<p>up 主应该都能看到是谁点赞了视频吧，点赞后，立即取消点赞。up 主还会知道谁赞了这个视频吗？</p>\n", "last_modified": 1761960622, "replies": 30, "id": 1169833}, {"node": {"avatar_large": "https://cdn.v2ex.com/navatar/3cef/96dc/949_large.png?m=1730363795", "name": "nas", "avatar_normal": "https://cdn.v2ex.com/navatar/3cef/96dc/949_normal.png?m=1730363795", "title": "NAS", "url": "https://www.v2ex.com/go/nas", "topics": 3004, "footer": "", "header": "关于网络存储设备的讨论", "title_alternative": "NAS", "avatar_mini": "https://cdn.v2ex.com/navatar/3cef/96dc/949_mini.png?m=1730363795", "stars": 2956, "aliases": [], "root": false, "id": 949, "parent_node_name": "hardware"}, "member": {"id": 758918, "username": "mystical", "url": "https://www.v2ex.com/u/mystical", "website": null, "twitter": null, "psn": null, "github": null, "btc": null, "location": null, "tagline": null, "bio": null, "avatar_mini": "https://cdn.v2ex.com/avatar/142d/6dc1/758918_mini.png?m=1758877979", "avatar_normal": "https://cdn.v2ex.com/avatar/142d/6dc1/758918_normal.png?m=1758877979", "avatar_large": "https://cdn.v2ex.com/avatar/142d/6dc1/758918_large.png?m=1758877979", "avatar_xlarge": "https://cdn.v2ex.com/avatar/142d/6dc1/758918_xlarge.png?m=1758877979", "avatar_xxlarge": "https://cdn.v2ex.com/avatar/142d/6dc1/758918_xxlarge.png?m=1758877979", "avatar_xxxlarge": "https://cdn.v2ex.com/avatar/142d/6dc1/758918_xxxlarge.png?m=1758877979", "created": 1753236507, "last_modified": 1758877979, "pro": 0}, "last_reply_by": "ctong", "last_touched": 1761941499, "title": "nas 的影音工具你们用的什么", "url": "https://www.v2ex.com/t/1169749", "created": 1761900738, "deleted": 0, "content": "我有个飞牛系统，飞牛的影音感觉特别好用。匹配的很准\r\n\r\n我还有个 ubuntu ，里面装了 jellyfin ，但是匹配速度提别慢，还不准。ubuntu 是开发机，装不了飞牛，有哪些好用的 linux 影印工具推荐一下，可以跑在 docker 里的那种。要求不高，能刮削海报中文字母就行", "content_rendered": "我有个飞牛系统，飞牛的影音感觉特别好用。匹配的很准<br /><br />我还有个 ubuntu ，里面装了 jellyfin ，但是匹配速度提别慢，还不准。ubuntu 是开发机，装不了飞牛，有哪些好用的 linux 影印工具推荐一下，可以跑在 docker 里的那种。要求不高，能刮削海报中文字母就行", "last_modified": 1761900738, "replies": 29, "id": 1169749}, {"node": {"avatar_large": "https://cdn.v2ex.com/navatar/38af/8613/176_large.png?m=1644885960", "name": "car", "avatar_normal": "https://cdn.v2ex.com/navatar/38af/8613/176_normal.png?m=1644885960", "title": "汽车", "url": "https://www.v2ex.com/go/car", "topics": 3039, "footer": "", "header": "关于买车、开车及汽车文化的技术讨论", "title_alternative": "Car", "avatar_mini": "https://cdn.v2ex.com/navatar/38af/8613/176_mini.png?m=1644885960", "stars": 2212, "aliases": [], "root": false, "id": 176, "parent_node_name": "life"}, "member": {"id": 547448, "username": "sickoo", "url": "https://www.v2ex.com/u/sickoo", "website": "www.ouvg.top", "twitter": "mcDona1dSH0P", "psn": "", "github": "", "btc": "", "location": "", "tagline": "", "bio": "止不住眼泪的老实人~\r\nTG：@maimenBot\r\n\r\n下面是小广告：\r\nTG会员代开、推特蓝V代开\r\nMidjourney、Niji订阅代开\r\n需要会员代开、国外社交账户等\r\n发卡网[v2友优惠]：https://ouvg.top", "avatar_mini": "https://cdn.v2ex.com/avatar/97d0/0df2/547448_mini.png?m=1745990885", "avatar_normal": "https://cdn.v2ex.com/avatar/97d0/0df2/547448_normal.png?m=1745990885", "avatar_large": "https://cdn.v2ex.com/avatar/97d0/0df2/547448_large.png?m=1745990885", "avatar_xlarge": "https://cdn.v2ex.com/avatar/97d0/0df2/547448_xlarge.png?m=1745990885", "avatar_xxlarge": "https://cdn.v2ex.com/avatar/97d0/0df2/547448_xxlarge.png?m=1745990885", "created": 1622869871, "last_modified": 1745990885, "pro": 0}, "last_reply_by": "kerwin1874", "last_touched": 1761918279, "title": "想问问大家平时去哪洗车？", "url": "https://www.v2ex.com/t/1169726", "created": 1761896115, "deleted": 0, "content": "终于脏到门把手，要动身送去洗车了！\r\n\r\n看了张大妈帖子评论，说京东 Plus 送的洗车权益，难预约还洗的不干净，就算 19.9 也不太敢买\r\n\r\n没试过途虎、天猫，求科普科普", "content_rendered": "<p>终于脏到门把手，要动身送去洗车了！</p>\n<p>看了张大妈帖子评论，说京东 Plus 送的洗车权益，难预约还洗的不干净，就算 19.9 也不太敢买</p>\n<p>没试过途虎、天猫，求科普科普</p>\n", "last_modified": 1761896115, "replies": 24, "id": 1169726}, {"node": {"avatar_large": "https://cdn.v2ex.com/navatar/f61d/6947/375_large.png?m=1658910399", "name": "go", "avatar_normal": "https://cdn.v2ex.com/navatar/f61d/6947/375_normal.png?m=1658910399", "title": "Go 编程语言", "url": "https://www.v2ex.com/go/go", "topics": 3298, "footer": "", "header": "Go 是一个开源的编程语言，它能让构造简单、可靠且高效的软件变得容易。", "title_alternative": "The Go Programming Language", "avatar_mini": "https://cdn.v2ex.com/navatar/f61d/6947/375_mini.png?m=1658910399", "stars": 4134, "aliases": [], "root": false, "id": 375, "parent_node_name": "programming"}, "member": {"id": 500446, "username": "Qjues", "url": "https://www.v2ex.com/u/Qjues", "website": null, "twitter": null, "psn": null, "github": null, "btc": null, "location": null, "tagline": null, "bio": null, "avatar_mini": "https://cdn.v2ex.com/gravatar/2e3b5be844adf24bb237f272eb0c7791?s=24&d=retro", "avatar_normal": "https://cdn.v2ex.com/gravatar/2e3b5be844adf24bb237f272eb0c7791?s=48&d=retro", "avatar_large": "https://cdn.v2ex.com/gravatar/2e3b5be844adf24bb237f272eb0c7791?s=73&d=retro", "created": 1595482947, "last_modified": 1761903293, "pro": 0}, "last_reply_by": "ksedz", "last_touched": 1761944815, "title": "日期函数获取上一个月 bug, 在一些特殊日子才出现，比如今天 10-31", "url": "https://www.v2ex.com/t/1169781", "created": 1761906928, "deleted": 0, "content": "今天生产环境出现比较多的异常，挺纳闷的，毕竟最近该服务没有怎么迭代。\r\n\r\n经过排查定位发现，居然是某些特殊日子才会出现的问题。\r\n\r\n\r\nRetentionMonths = 3\r\nMonthTablePrefix = \"jobs_\"\r\n\r\n代码是一个分表逻辑中，获取最近月份的表，通过 `AddDate(0, -i, 0)` 函数获取前几个月的表。应返回当前月和前 3 个月的分表名数组。`[jobs_202510 jobs_202509 jobs_202508 jobs_202507]`（ golang 1.19 ）\r\n\r\n```\r\n// GetRecentHotTables 获取最近 n 个月的热表名称列表\r\nfunc (j jobPartitionRepositoryImpl) GetRecentHotTables() []string {\r\n\tmonths := RetentionMonths\r\n\r\n\ttables := make([]string, 0, months)\r\n\tnow := time.Now()\r\n\r\n\tfor i := 0; i <= months; i++ {\r\n\t\tdate := now.AddDate(0, -i, 0)\r\n\t\tyear := date.Format(\"2006\")\r\n\t\tmonth := date.Format(\"01\")\r\n\t\ttableName := fmt.Sprintf(\"%s%s%s\", MonthTablePrefix, year, month)\r\n\t\ttables = append(tables, tableName)\r\n\t}\r\n\r\n\treturn tables\r\n}\r\n```\r\n\r\n光看代码感觉是没啥问题的，为啥怀疑到这段代码，也是通过日志发现，查询表的 sql 只查 2025-10, 2025-08, 2025-07 表，缺了 2025-09 表。\r\n\r\n所以本地验证一番。（单元测试还通过了。。。因为验证的代码和里面一样。。。）\r\n\r\n```\r\n=== RUN   TestGetRecentHotTables\r\n--- PASS: TestGetRecentHotTables (0.00s)\r\n=== RUN   TestGetRecentHotTables/默认获取最近 3 个月表\r\n[jobs_202510 jobs_202510 jobs_202508 jobs_202507]\r\n    --- PASS: TestGetRecentHotTables/默认获取最近 3 个月表 (0.00s)\r\nPASS\r\n```\r\n\r\n看输出发现 `jobs_202510 jobs_202510` 有两个，问题就在这里了。\r\n\r\n```\r\nnow := time.Now()\r\nfmt.Println(now.AddDate(0, -1, 0).Format(\"200601\"))\r\n```\r\n\r\n预期是输出 202509 的，但现实是 `202510`\r\n\r\n那为什么呢？通过询问 google ，找到下面相关文章说明，大致意思就是，因为 10-31 减去一个月为 09-31, 但是又因为 9 月没有 31 号，就将日期标准化为 10-01 ，保证了 time 值的有效性。\r\n\r\nhttps://github.com/golang/go/issues/31145\r\nhttps://learnku.com/articles/71760\r\n\r\n在 learnku 文章中提到 php ，然后用 php 类似函数试了一下，也有类似问题（ php8.1 ）\r\n\r\n```\r\necho date('Y-m-d', strtotime('-1 months'));\r\n\r\n// 2025-10-01\r\n```\r\n\r\n周五给我整个这个，真是够了。\r\n\r\n修改方案, 减去当前时间的天数，时间调整到上一个月最后一天:\r\n\r\n```\r\nnow := time.Now()\r\nnow.AddDate(0, 0, -now.Day())\r\n```\r\n\r\njs moment 试了是正常的\r\n\r\n```\r\nconsole.log(moment(new Date()).subtract(1, 'months').format('YYYY-MM-DD'))\r\n```", "content_rendered": "<p>今天生产环境出现比较多的异常，挺纳闷的，毕竟最近该服务没有怎么迭代。</p>\n<p>经过排查定位发现，居然是某些特殊日子才会出现的问题。</p>\n<p>RetentionMonths = 3\nMonthTablePrefix = \"jobs_\"</p>\n<p>代码是一个分表逻辑中，获取最近月份的表，通过 <code>AddDate(0, -i, 0)</code> 函数获取前几个月的表。应返回当前月和前 3 个月的分表名数组。<code>[jobs_202510 jobs_202509 jobs_202508 jobs_202507]</code>（ golang 1.19 ）</p>\n<pre><code>// GetRecentHotTables 获取最近 n 个月的热表名称列表\nfunc (j jobPartitionRepositoryImpl) GetRecentHotTables() []string {\n\tmonths := RetentionMonths\n\n\ttables := make([]string, 0, months)\n\tnow := time.Now()\n\n\tfor i := 0; i &lt;= months; i++ {\n\t\tdate := now.AddDate(0, -i, 0)\n\t\tyear := date.Format(\"2006\")\n\t\tmonth := date.Format(\"01\")\n\t\ttableName := fmt.Sprintf(\"%s%s%s\", MonthTablePrefix, year, month)\n\t\ttables = append(tables, tableName)\n\t}\n\n\treturn tables\n}\n</code></pre>\n<p>光看代码感觉是没啥问题的，为啥怀疑到这段代码，也是通过日志发现，查询表的 sql 只查 2025-10, 2025-08, 2025-07 表，缺了 2025-09 表。</p>\n<p>所以本地验证一番。（单元测试还通过了。。。因为验证的代码和里面一样。。。）</p>\n<pre><code>=== RUN   TestGetRecentHotTables\n--- PASS: TestGetRecentHotTables (0.00s)\n=== RUN   TestGetRecentHotTables/默认获取最近 3 个月表\n[jobs_202510 jobs_202510 jobs_202508 jobs_202507]\n    --- PASS: TestGetRecentHotTables/默认获取最近 3 个月表 (0.00s)\nPASS\n</code></pre>\n<p>看输出发现 <code>jobs_202510 jobs_202510</code> 有两个，问题就在这里了。</p>\n<pre><code>now := time.Now()\nfmt.Println(now.AddDate(0, -1, 0).Format(\"200601\"))\n</code></pre>\n<p>预期是输出 202509 的，但现实是 <code>202510</code></p>\n<p>那为什么呢？通过询问 google ，找到下面相关文章说明，大致意思就是，因为 10-31 减去一个月为 09-31, 但是又因为 9 月没有 31 号，就将日期标准化为 10-01 ，保证了 time 值的有效性。</p>\n<p><a href=\"https://github.com/golang/go/issues/31145\" rel=\"nofollow\">https://github.com/golang/go/issues/31145</a>\n<a href=\"https://learnku.com/articles/71760\" rel=\"nofollow\">https://learnku.com/articles/71760</a></p>\n<p>在 learnku 文章中提到 php ，然后用 php 类似函数试了一下，也有类似问题（ php8.1 ）</p>\n<pre><code>echo date('Y-m-d', strtotime('-1 months'));\n\n// 2025-10-01\n</code></pre>\n<p>周五给我整个这个，真是够了。</p>\n<p>修改方案, 减去当前时间的天数，时间调整到上一个月最后一天:</p>\n<pre><code>now := time.Now()\nnow.AddDate(0, 0, -now.Day())\n</code></pre>\n<p>js moment 试了是正常的</p>\n<pre><code>console.log(moment(new Date()).subtract(1, 'months').format('YYYY-MM-DD'))\n</code></pre>\n", "last_modified": 1761906928, "replies": 20, "id": 1169781}]